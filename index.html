<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Primary Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tracker 2026">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Tracker 2026">
    <meta name="theme-color" content="#050810">
    
    <!-- Ikon (Gunakan JPG kamu) -->
    <link rel="apple-touch-icon" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg?v=2026">
    <link rel="icon" type="image/jpeg" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg?v=2026">
    
    <!-- Manifest Dinamis -->
    <link rel="manifest" id="pwa-manifest">

    <title>2026 Elite Discipline Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050810;
            color: #e2e8f0;
            letter-spacing: -0.01em;
            overscroll-behavior-y: contain;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .status-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .status-none { background-color: #1e293b; color: #94a3b8; }
        .status-done { background-color: #10b981 !important; color: white !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        .status-fail { background-color: #ef4444 !important; color: white !important; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        .note-input {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            font-size: 12px;
        }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.2s;
            font-size: 0.75rem;
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        }

        .task-done-text { color: #64748b; text-decoration: line-through; opacity: 0.7; }

        #syncIndicator {
            position: fixed; bottom: 20px; right: 20px; padding: 10px 18px;
            border-radius: 99px; font-size: 11px; font-weight: 800;
            z-index: 100; display: flex; align-items: center; gap: 10px;
            text-transform: uppercase; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5);
        }

        .state-online { background: #064e3b; color: #34d399; border: 1px solid #059669; }
        .state-offline { background: #450a0a; color: #f87171; border: 1px solid #b91c1c; }
        .state-syncing { background: #451a03; color: #fbbf24; border: 1px solid #d97706; }

        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; position: relative; }
        .pulse-dot::after {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background-color: currentColor; animation: pulse 1.5s infinite; left: 0; top: 0;
        }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        select { background-color: #1e293b; color: #f1f5f9; border: 1px solid rgba(255, 255, 255, 0.1); padding: 6px 12px; border-radius: 10px; font-size: 13px; }

        .attachment-badge { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); padding: 4px 8px; border-radius: 8px; display: flex; align-items: center; gap: 6px; font-size: 10px; color: #93c5fd; max-width: 150px; }
        .attachment-preview { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }

        .fasting-alert { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 800; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
        
        /* Timer Styles */
        .timer-panel { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 12px; margin-top: 10px; flex-direction: column; align-items: center; }
        .timer-display { font-family: 'Courier New', Courier, monospace; font-weight: 800; color: #60a5fa; font-size: 1.5rem; }
        .pomo-badge { font-size: 9px; padding: 2px 8px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        
        footer { border-top: 1px solid rgba(255, 255, 255, 0.05); text-align: center; padding: 40px 20px; color: #64748b; font-size: 10px; font-weight: 700; letter-spacing: 1px; line-height: 1.6; }

        .notif-active { color: #10b981; }
        .notif-blocked { color: #ef4444; }
    </style>
</head>
<body class="bg-[#050810]">

    <div id="syncIndicator" class="state-syncing">
        <div class="pulse-dot"></div>
        <span id="syncText">Menghubungkan...</span>
    </div>

    <header class="sticky top-0 z-50 bg-[#050810]/80 backdrop-blur-xl border-b border-white/5 p-5">
        <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 items-center gap-6 text-center md:text-left">
            <div class="flex items-center gap-3 justify-center md:justify-start">
                <div class="w-1 h-10 bg-blue-500 rounded-full"></div>
                <div>
                    <p id="quoteText" class="text-[11px] text-slate-300 italic min-h-[30px]">"Memuat..."</p>
                    <button id="notifStatusBtn" onclick="window.requestNotifPermission()" class="text-[9px] font-bold uppercase tracking-widest mt-1 flex items-center gap-1">
                        <i id="notifIcon" class="fas fa-bell"></i> <span id="notifText">Notif: Cek Izin</span>
                    </button>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <h1 class="text-2xl font-extrabold text-white flex items-center gap-2">
                    <span class="text-blue-500"><i class="fas fa-bolt"></i></span> FOCUS LOG
                </h1>
                <p id="currentSelectionLabel" class="text-[11px] text-blue-400 font-bold uppercase mt-1">01 JAN 2026</p>
            </div>
            <div class="flex items-center justify-center md:justify-end gap-3">
                <select id="monthSelect" onchange="window.updateCalendarView()"></select>
                <select id="yearSelect" onchange="window.updateCalendarView()"></select>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-6 pb-20">
        <div class="glass-card p-6 rounded-[2rem] mb-10">
            <div class="grid grid-cols-7 gap-3 text-center mb-4 font-black text-slate-500 text-[10px] uppercase">
                <span>Min</span><span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-3"></div>
        </div>

        <div id="dayTrackerArea">
            <div id="dayHeader" class="flex items-end justify-between mb-8 px-2">
                <div>
                    <div id="fastingBadgeContainer"></div>
                    <h2 id="dayFullLabel" class="text-2xl font-extrabold text-white leading-none">...</h2>
                    <div class="flex items-center gap-3 mt-3">
                        <span id="sportTargetLabel" class="text-[11px] bg-blue-500/10 text-blue-400 px-3 py-1 rounded-full font-bold uppercase border border-blue-500/20">...</span>
                    </div>
                </div>
                <div class="text-right">
                    <span id="dayScore" class="text-4xl font-black text-emerald-400">0%</span>
                    <p class="text-[10px] text-slate-500 uppercase font-black">Skor Progres</p>
                </div>
            </div>

            <div class="mb-6 px-2">
                <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-[3px] mb-4">Jadwal Utama</h3>
                <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
            </div>

            <div class="mt-12 px-2">
                <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[3px] mb-4">Tugas Rutin & Ibadah</h3>
                <div id="extraTaskList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
            </div>
        </div>
    </main>

    <footer>
        <p>Â© 2026 ELITE DISCIPLINE TRACKER | ALL RIGHTS RESERVED</p>
        <p class="mt-1 opacity-40 font-medium uppercase text-[8px] sm:text-[10px]">Dirancang untuk Performa Tinggi & Kedisiplinan Mutlak</p>
    </footer>

    <input type="file" id="globalFileInput" class="hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Quotes logic (365 days cycle)
        const yearlyQuotes = [
            "Disiplin adalah jembatan antara target dan pencapaian.",
            "Waktu lo terbatas, jangan sia-siakan untuk hal yang nggak guna.",
            "Kemenangan dimulai dari jam 03:30 pagi.",
            "Fokus adalah kekuatan lo, asah terus setiap detik.",
            "Tahun 2026 adalah tahun pembuktian diri lo, bro.",
            "Jangan biarkan rasa malas mencuri masa depan lo.",
            "Lakukan hari ini apa yang orang lain tunda.",
            "Disiplin diri adalah bentuk tertinggi dari rasa cinta diri.",
            "Konsistensi lebih penting daripada intensitas sesaat.",
            "Terus melangkah, meskipun langkah itu kecil."
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyD6eXPEfB8aonq7M0c6pU4sVPlGoRJtYCQ",
            authDomain: "tracker-2026-4bbd9.firebaseapp.com",
            projectId: "tracker-2026-4bbd9",
            storageBucket: "tracker-2026-4bbd9.firebasestorage.app",
            messagingSenderId: "634119648342",
            appId: "1:634119648342:web:35aff0729cdcb37dcc37f7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const trackerId = "discipline-tracker-2026";

        // Enable Offline Storage
        enableIndexedDbPersistence(db).catch(() => {});

        let currentUser = null;
        let dayUnsubscribe = null;
        let selectedDate = new Date(2026, 0, 1);
        let cloudData = {};
        let activeItemIdForUpload = null;
        let lastNotifDate = null;
        
        // Timer panel states
        window.openTimerPanels = {};

        // Register a dummy service worker to satisfy PWA requirements for "Install" prompt
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `self.addEventListener('fetch', (event) => { event.respondWith(fetch(event.request)); });`;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(err => console.log('SW failed', err));
            });
        }

        // --- GLOBAL FUNCTIONS ---
        window.initAuth = async function() {
            updateSyncUI();
            try { await signInAnonymously(auth); } catch (e) { updateSyncUI(); }
        };

        window.requestNotifPermission = () => {
            if (!("Notification" in window)) return;
            Notification.requestPermission().then(p => {
                const icon = document.getElementById('notifIcon'), label = document.getElementById('notifText');
                if (p === "granted") { 
                    if (icon) icon.className = "fas fa-bell notif-active"; 
                    if (label) label.innerText = "Reminder Aktif (03:30)"; 
                } else { 
                    if (icon) icon.className = "fas fa-bell notif-blocked"; 
                    if (label) label.innerText = "Notif Diblokir"; 
                }
            });
        };

        // --- TIMER ENGINE ---
        window.toggleTimerPanel = (id) => {
            window.openTimerPanels[id] = !window.openTimerPanels[id];
            renderDayTracker();
        };

        window.startCountdown = (id, durationMs, isPomo = false) => {
            const taskData = cloudData[id] || {};
            if (taskData.timerRunning) return;

            taskData.timerRunning = true;
            taskData.timerEnd = Date.now() + (taskData.remainingMs !== null && taskData.remainingMs !== undefined ? taskData.remainingMs : durationMs);
            taskData.isPomo = isPomo;
            
            if (isPomo && !taskData.pomoState) {
                taskData.pomoState = 'work';
                taskData.pomoCycle = 1;
                taskData.timerEnd = Date.now() + (25 * 60000);
            }

            cloudData[id] = taskData;
            saveToFirestore();
            renderDayTracker();
        };

        window.pauseCountdown = (id) => {
            const taskData = cloudData[id] || {};
            if (!taskData.timerRunning) return;

            taskData.timerRunning = false;
            taskData.remainingMs = taskData.timerEnd - Date.now();
            cloudData[id] = taskData;
            saveToFirestore();
            renderDayTracker();
        };

        window.stopTimer = (id) => {
            const item = getItemById(id);
            const defaultDuration = item ? (item.duration || 25*60000) : 25*60000;
            cloudData[id] = { ...cloudData[id], timerRunning: false, timerEnd: null, remainingMs: defaultDuration, pomoState: null, pomoCycle: null };
            saveToFirestore();
            renderDayTracker();
        };

        const getItemById = (id) => {
            const allPossible = [
                { id: "english", duration: 30 * 60000 },
                { id: "muscle_subuh", duration: 20 * 60000 },
                { id: "sport", noTimer: true },
                { id: "deep1", duration: 210 * 60000 },
                { id: "muscle_dzuhur", duration: 20 * 60000 },
                { id: "deep2", duration: 60 * 60000 },
                { id: "majelis", duration: 240 * 60000 },
                { id: "skipping", duration: 15 * 60000 },
                { id: "quran", duration: 20 * 60000 },
                { id: "buku", isPomo: true }
            ];
            return allPossible.find(x => x.id === id);
        };

        const formatTime = (ms) => {
            if (ms <= 0) return "00:00";
            const totalSec = Math.floor(ms / 1000);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h > 0 ? h + ':' : ''}${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const updateSyncUI = () => {
            const indicator = document.getElementById('syncIndicator'), syncText = document.getElementById('syncText');
            if (!indicator) return;
            if (!navigator.onLine) { indicator.className = 'state-offline'; syncText.innerText = "Mode Offline"; }
            else if (currentUser) { indicator.className = 'state-online'; syncText.innerText = "Cloud Online"; }
            else { indicator.className = 'state-syncing'; syncText.innerText = "Menghubungkan..."; }
        };

        window.addEventListener('online', updateSyncUI);
        window.addEventListener('offline', updateSyncUI);

        onAuthStateChanged(auth, (user) => { 
            currentUser = user; 
            updateSyncUI(); 
            if (user) {
                setupRealtimeSync(); 
                if (Notification.permission === "granted") {
                    const icon = document.getElementById('notifIcon'), label = document.getElementById('notifText');
                    if (icon) icon.className = "fas fa-bell notif-active"; 
                    if (label) label.innerText = "Reminder Aktif (03:30)";
                }
            } 
        });

        const setupRealtimeSync = () => {
            if (!currentUser) return;
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            if (dayUnsubscribe) dayUnsubscribe();
            dayUnsubscribe = onSnapshot(doc(db, 'artifacts', trackerId, 'users', currentUser.uid, 'calendar', docId), (snap) => {
                cloudData = snap.exists() ? snap.data() : {};
                renderDayTracker();
            });
            window.updateCalendarView();
        };

        const saveToFirestore = async () => { 
            if (!currentUser) return; 
            await setDoc(doc(db, 'artifacts', trackerId, 'users', currentUser.uid, 'calendar', `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`), cloudData); 
        };

        const isFastingDay = (date) => {
            const day = date.getDay(), ramadanStart = new Date(2026, 1, 18), ramadanEnd = new Date(2026, 2, 19);
            if (date >= ramadanStart && date <= ramadanEnd) return "Ramadhan";
            if (day === 1) return "Senin"; if (day === 4) return "Kamis";
            return null;
        };

        const calculateSportTarget = (date) => {
            const day = date.getDay();
            const month = date.getMonth();
            const fasting = isFastingDay(date);
            const baseSportSchedule = { 
                1: { type: "Gowes", val: 25 }, 2: { type: "Gowes", val: 25 }, 
                3: { type: "Run", val: 5 }, 4: { type: "Gowes", val: 30 }, 
                5: { type: "Gowes", val: 20 }, 6: { type: "Run", val: 5 }, 0: { type: "Rest", val: 0 } 
            };
            const sched = baseSportSchedule[day];
            if (sched.type === "Rest") return "ðŸ›Œ Total Rest";
            let runDist = 5 + Math.floor(month / 3);
            if (fasting === "Ramadhan") {
                if (sched.type === "Gowes") return `ðŸš´ Gowes Santai ${sched.val} KM (Low Intensity)`;
                return "ðŸš¶ Steps 10k - 20k / Lari Pendek 2KM";
            }
            if (sched.type === "Run") return `ðŸƒ Lari ${runDist} KM (Target Progresif)`;
            return `ðŸš´ Gowes ${sched.val} KM`;
        };

        const renderDayTracker = () => {
            const isFriday = selectedDate.getDay() === 5;
            const isThursday = selectedDate.getDay() === 4;
            const isMonday = selectedDate.getDay() === 1;
            const dayNum = selectedDate.getDate();
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            
            document.getElementById('dayFullLabel').innerText = `${dayNames[selectedDate.getDay()]}, ${dayNum} ${monthNames[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`;
            document.getElementById('currentSelectionLabel').innerText = `${dayNum < 10 ? '0'+dayNum : dayNum} ${monthNames[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`;
            
            const quoteIdx = (dayNum + selectedDate.getMonth() * 31) % yearlyQuotes.length;
            document.getElementById('quoteText').innerText = `"${yearlyQuotes[quoteIdx]}"`;
            
            const fastingType = isFastingDay(selectedDate);
            document.getElementById('fastingBadgeContainer').innerHTML = fastingType ? `<div class="fasting-alert">Puasa ${fastingType}</div>` : '';
            
            const currentSportGoal = calculateSportTarget(selectedDate);
            document.getElementById('sportTargetLabel').innerText = currentSportGoal;

            const baseRoutine = [
                { id: "english", time: "03:30", task: "Belajar Bahasa Inggris", icon: "fa-language", duration: 30 * 60000 },
                { id: "subuh", time: "04:15", task: "Bangun & Sholat Subuh", icon: "fa-mosque", noTimer: true },
                { id: "muscle_subuh", time: "05:00", task: "Muscle: Push Up & Pull Up", icon: "fa-dumbbell", weekdayOnly: true, duration: 20 * 60000 },
                { id: "sport", time: "05:50", task: "Olahraga: " + currentSportGoal, icon: "fa-running", noTimer: true },
                { id: "dhuha", time: "07:45", task: "Sholat Dhuha", icon: "fa-hands-praying", noTimer: true },
                { id: "deep1", time: "08:30", task: "Deep Work Sesi 1", icon: "fa-keyboard", duration: 210 * 60000 },
                { id: "dzuhur", time: "12:00", task: "Sholat Dzuhur Berjamaah", icon: "fa-sun", noTimer: true },
                { id: "muscle_dzuhur", time: "12:30", task: "Muscle: Push Up & Pull Up", icon: "fa-dumbbell", weekdayOnly: true, duration: 20 * 60000 },
                { id: "deep2", time: "13:30", task: isFriday ? "Deep Work (Sesi Pendek)" : "Deep Work Sesi 2", icon: "fa-brain", duration: 60 * 60000, hideOnFriday: isFriday },
                { id: "majelis", time: "14:30", task: "Jadwal Majelis", icon: "fa-users", fridayOnly: true, duration: 240 * 60000 },
                { id: "ashar", time: "15:30", task: "Sholat Ashar Berjamaah", icon: "fa-coffee", hideOnFriday: true, noTimer: true },
                { id: "skipping", time: "17:15", task: "Skipping (Sore)", icon: "fa-bolt", weekdayOnly: true, duration: 15 * 60000 },
                { id: "mandi", time: "17:45", task: "Mandi & Santai Sore", icon: "fa-bath", noTimer: true },
                { id: "maghrib", time: "18:00", task: "Sholat Maghrib Berjamaah", icon: "fa-moon", noTimer: true },
                { id: "quran", time: "18:20", task: "Membaca Al-Qur'an", icon: "fa-book-quran", duration: 20 * 60000 },
                { id: "isya", time: "18:45", task: "Sholat Isya Berjamaah", icon: "fa-star", noTimer: true },
                { id: "buku", time: "19:00", task: "Baca Buku (Pomodoro)", icon: "fa-book-open", isPomo: true },
                { id: "tidur", time: "20:30", task: "Tidur Malam", icon: "fa-bed", noTimer: true }
            ];

            const extraTasks = [
                { id: "siram_pagi", task: "Menyiram Tanaman (Pagi)", icon: "fa-faucet-drip" },
                { id: "siram_sore", task: "Menyiram Tanaman (Sore)", icon: "fa-faucet-drip" },
                { id: "kasur", task: "Membersihkan Kasur", icon: "fa-bed" },
                { id: "sapu", task: "Menyapu Rumah", icon: "fa-broom" },
                { id: "piring", task: "Mencuci Piring", icon: "fa-sink" },
                { id: "istigfar", task: "Istigfar 1000x", icon: "fa-comment-dots" },
                { id: "taubat", task: "Sholat Taubat", icon: "fa-person-praying" },
                { id: "kuku", task: "Potong Kuku (Khusus Senin, Kamis, Jum'at)", icon: "fa-scissors", specialDaysKuku: true },
                { id: "cuci", task: "Cuci Pakaian", icon: "fa-shirt", fridayOnly: true }
            ];

            const renderList = (list, containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return 0;
                container.innerHTML = '';
                let count = 0;
                list.forEach(item => {
                    if (item.fridayOnly && !isFriday) return;
                    if (item.specialDaysKuku && !isMonday && !isThursday && !isFriday) return;
                    if (item.hideOnFriday && isFriday) return;
                    if (item.weekdayOnly && (selectedDate.getDay() === 0 || selectedDate.getDay() === 6)) return;

                    const itemData = cloudData[item.id] || {};
                    const status = itemData.status || 'none';
                    const attachments = itemData.attachments || [];
                    if (status === 'done') count++;

                    const card = document.createElement('div');
                    card.className = 'glass-card p-5 rounded-2xl flex flex-col hover:scale-[1.01] transition-transform';
                    
                    let timerUI = '';
                    if (!item.noTimer && (item.duration || item.isPomo)) {
                        let remaining = itemData.remainingMs !== null && itemData.remainingMs !== undefined ? itemData.remainingMs : (item.duration || 25*60000);
                        if (itemData.timerRunning) remaining = itemData.timerEnd - Date.now();
                        
                        const isPanelOpen = window.openTimerPanels[item.id];
                        timerUI = `
                            <div id="timer-panel-${item.id}" class="timer-panel" style="display: ${isPanelOpen ? 'flex' : 'none'}">
                                ${itemData.isPomo ? `<span class="pomo-badge ${itemData.pomoState === 'work' ? 'bg-orange-500' : 'bg-emerald-500'} text-white">Cycle ${itemData.pomoCycle || 1}/3: ${itemData.pomoState || 'work'}</span>` : ''}
                                <span class="timer-display">${formatTime(remaining)}</span>
                                <div class="flex gap-4 mt-3">
                                    <button onclick="window.${itemData.timerRunning ? 'pauseCountdown' : 'startCountdown'}('${item.id}', ${item.duration || 25*60000}, ${!!item.isPomo})" class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center">
                                        <i class="fas ${itemData.timerRunning ? 'fa-pause' : 'fa-play'}"></i>
                                    </button>
                                    <button onclick="window.stopTimer('${item.id}')" class="w-10 h-10 rounded-full bg-rose-500/20 text-rose-400 flex items-center justify-center">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    let attHtml = attachments.length > 0 ? `<div class="flex flex-wrap gap-2 mt-3">` : '';
                    attachments.forEach((f, i) => { 
                        attHtml += `<div class="attachment-badge relative group">
                            ${f.data.startsWith('data:image/') ? `<img src="${f.data}" class="attachment-preview" />` : `<i class="fas fa-file-alt"></i>`}
                            <span class="truncate text-[9px] ml-1">${f.name}</span>
                            <button onclick="window.removeAttachment('${item.id}', ${i})" class="absolute -top-1 -right-1 bg-rose-500 text-white w-3 h-3 rounded-full text-[7px]"><i class="fas fa-times"></i></button>
                        </div>`; 
                    });
                    if (attachments.length > 0) attHtml += `</div>`;

                    card.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1 pr-2">
                                <div class="flex items-center gap-3 mb-2">
                                    ${item.time ? `<span class="text-[9px] font-black text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded uppercase">${item.time}</span>` : ''}
                                    <i class="fas ${item.icon} text-[10px] text-slate-500"></i>
                                    <h3 class="text-[13px] font-bold ${status === 'done' ? 'task-done-text' : 'text-slate-100'}">${item.task}</h3>
                                </div>
                                <textarea id="note-${item.id}" placeholder="Catatan..." class="note-input w-full mt-1 p-2 rounded-lg min-h-[40px] resize-none">${itemData.note || ''}</textarea>
                                ${attHtml}
                                <div class="flex gap-4 mt-3">
                                    <button onclick="window.triggerUpload('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-paperclip"></i> Berkas</button>
                                    ${!item.noTimer && (item.duration || item.isPomo) ? `<button onclick="window.toggleTimerPanel('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-clock"></i> Timer</button>` : ''}
                                </div>
                                ${timerUI}
                            </div>
                            <div class="flex flex-col gap-2 ml-2">
                                <button onclick="window.updateStatus('${item.id}', '${status === 'done' ? 'none' : 'done'}')" class="w-10 h-10 rounded-xl flex items-center justify-center status-btn ${status === 'done' ? 'status-done' : 'status-none'}"><i class="fas fa-check"></i></button>
                                <button onclick="window.updateStatus('${item.id}', '${status === 'fail' ? 'none' : 'fail'}')" class="w-10 h-10 rounded-xl flex items-center justify-center status-btn ${status === 'fail' ? 'status-fail' : 'status-none'}"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                    
                    card.querySelector(`#note-${item.id}`).onblur = (e) => window.updateNote(item.id, e.target.value);
                    container.appendChild(card);
                });
                return count;
            };

            const mainDone = renderList(baseRoutine, 'taskList');
            const extraDone = renderList(extraTasks, 'extraTaskList');
            
            const totalTasks = document.querySelectorAll('.glass-card').length;
            const score = totalTasks ? Math.round(((mainDone + extraDone) / totalTasks) * 100) : 0;
            document.getElementById('dayScore').innerText = score + '%';
        };

        window.updateStatus = async (id, s) => { cloudData[id] = { ...cloudData[id], status: s }; renderDayTracker(); saveToFirestore(); };
        window.updateNote = async (id, n) => { if (cloudData[id]?.note === n) return; cloudData[id] = { ...cloudData[id], note: n }; saveToFirestore(); };

        window.triggerUpload = (id) => { activeItemIdForUpload = id; document.getElementById('globalFileInput').click(); };
        document.getElementById('globalFileInput').onchange = async (e) => {
            const files = Array.from(e.target.files); if (!files.length || !activeItemIdForUpload) return;
            const attachments = cloudData[activeItemIdForUpload]?.attachments || [];
            for (let f of files) {
                if (f.size > 200 * 1024) continue;
                const r = new FileReader(); r.readAsDataURL(f);
                r.onload = async () => {
                    attachments.push({ name: f.name, type: f.type, data: r.result });
                    cloudData[activeItemIdForUpload] = { ...cloudData[activeItemIdForUpload], attachments };
                    renderDayTracker(); saveToFirestore();
                };
            }
            e.target.value = '';
        };
        window.removeAttachment = async (id, i) => { cloudData[id].attachments.splice(i, 1); renderDayTracker(); saveToFirestore(); };

        window.updateCalendarView = () => {
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect'), grid = document.getElementById('calendarGrid');
            if (!yS || !mS || !grid) return;
            const year = parseInt(yS.value), month = parseInt(mS.value);
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const dayEl = document.createElement('div');
                const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                dayEl.className = `calendar-day relative glass-card ${isSelected ? 'active' : ''}`;
                dayEl.innerText = d;
                dayEl.onclick = () => { selectedDate = new Date(year, month, d); setupRealtimeSync(); };
                grid.appendChild(dayEl);
            }
        };

        // --- TICKER LOOP ---
        setInterval(() => {
            let needsRerender = false;
            Object.keys(cloudData).forEach(id => {
                if (cloudData[id].timerRunning) {
                    needsRerender = true;
                    let remaining = cloudData[id].timerEnd - Date.now();
                    
                    if (remaining <= 0) {
                        if ("vibrate" in navigator) navigator.vibrate([400, 200, 400, 200, 600]);
                        if (id === 'buku') {
                            if (cloudData[id].pomoState === 'work') {
                                cloudData[id].pomoState = 'rest';
                                cloudData[id].timerEnd = Date.now() + (5 * 60000);
                            } else {
                                cloudData[id].pomoState = 'work';
                                cloudData[id].pomoCycle = (cloudData[id].pomoCycle || 1) < 3 ? (cloudData[id].pomoCycle || 1) + 1 : 1;
                                cloudData[id].timerEnd = Date.now() + (25 * 60000);
                                if (cloudData[id].pomoCycle === 1 && cloudData[id].pomoState === 'work') cloudData[id].timerRunning = false;
                            }
                        } else {
                            cloudData[id].timerRunning = false;
                        }
                        saveToFirestore();
                    }
                }
            });
            if (needsRerender) renderDayTracker();
            
            const now = new Date();
            const witaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Makassar"}));
            if (witaTime.getHours() === 3 && witaTime.getMinutes() === 30 && lastNotifDate !== witaTime.toDateString()) {
                if (Notification.permission === "granted") {
                    new Notification("Tracker 2026", { body: "Bangun, bro! Jam 03:30 WITA. Waktunya eksekusi disiplin.", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg" });
                    lastNotifDate = witaTime.toDateString();
                }
            }
        }, 1000);

        // --- MANIFEST GENERATION ---
        const manifest = {
            "name": "Discipline Tracker 2026",
            "short_name": "Tracker2026",
            "start_url": window.location.href,
            "display": "standalone",
            "background_color": "#050810",
            "theme_color": "#050810",
            "icons": [{ "src": "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg?v=2026", "sizes": "731x731", "type": "image/jpeg", "purpose": "any maskable" }]
        };
        document.getElementById('pwa-manifest').setAttribute('href', `data:application/manifest+json,${encodeURIComponent(JSON.stringify(manifest))}`);

        window.addEventListener('load', () => {
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect');
            for(let y=2026; y<=2030; y++) { let o = document.createElement('option'); o.value = y; o.innerText = y; yS.appendChild(o); }
            ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].forEach((m, i) => { let o = document.createElement('option'); o.value = i; o.innerText = m; mS.appendChild(o); });
            yS.value = "2026"; mS.value = "0"; 
            window.initAuth();
            window.updateCalendarView();
            renderDayTracker();
            if (typeof Notification !== "undefined" && Notification.permission === "default") setTimeout(window.requestNotifPermission, 2000);
        });
    </script>
</body>
</html>
