<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Disipline Tracker">
    <meta name="theme-color" content="#050810">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icon Aplikasi (Tetap menggunakan logo gambar untuk shortcut HP) -->
    <link rel="apple-touch-icon" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg">
    <link rel="icon" type="image/jpeg" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg">
    
    <!-- Manifest Placeholder -->
    <link rel="manifest" id="pwa-manifest">

    <title>Disipline Tracker 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050810;
            color: #e2e8f0;
            letter-spacing: -0.01em;
            overscroll-behavior-y: contain;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .status-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .status-none { background-color: #1e293b; color: #94a3b8; }
        .status-done { background-color: #10b981 !important; color: white !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        .status-fail { background-color: #ef4444 !important; color: white !important; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.2s;
            font-size: 0.75rem;
            color: #64748b;
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        }

        .status-pill {
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.05);
        }

        #syncIndicator { position: fixed; bottom: 25px; right: 25px; z-index: 100; transition: all 0.3s ease; }
        .state-online { background: #064e3b; color: #34d399; }
        .state-offline { background: #450a0a; color: #f87171; }

        .pulse-dot { width: 6px; height: 6px; border-radius: 50%; background-color: currentColor; position: relative; }
        .pulse-dot::after {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background-color: currentColor; animation: pulse 1.5s infinite; left: 0; top: 0;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        .notif-active { color: #10b981 !important; }
        .notif-prompt { color: #f59e0b !important; }
        .notif-blocked { color: #ef4444 !important; }

        .note-input {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            font-size: 11px;
        }

        #imagePreviewModal {
            display: none; position: fixed; inset: 0; z-index: 12000;
            background: rgba(0,0,0,0.95); padding: 20px;
            flex-direction: column; align-items: center; justify-content: center;
        }
        
        footer { border-top: 1px solid rgba(255, 255, 255, 0.05); text-align: center; padding: 40px 20px; color: #64748b; font-size: 10px; font-weight: 700; letter-spacing: 1px; line-height: 1.6; }

        select { 
            background-color: #1e293b; 
            color: #f1f5f9; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 12px 20px; 
            border-radius: 14px; 
            cursor: pointer; 
            outline: none; 
            font-size: 16px; 
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .attachment-badge { 
            background: rgba(59, 130, 246, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            padding: 4px 8px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 10px; 
            color: #94a3b8; 
            cursor: pointer;
        }
        .attachment-preview { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background: #0f172a; }
        .fasting-alert { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 800; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }

        /* Bingkai Login (Pembatas Area Akses) */
        .login-frame {
            position: relative;
            padding: 10px;
            border-radius: 3rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.05);
            max-width: 600px;
            margin: 40px auto;
            z-index: 10;
        }

        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        #appMessage {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20000;
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .msg-hide { opacity: 0; transform: translate(-50%, -20px); }

        #mainHeader { transition: all 0.3s ease; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .header-clean { border-bottom-color: transparent !important; background: transparent !important; }
    </style>
</head>
<body class="bg-[#050810]">

    <!-- Message Hub (Floating UI feedback) -->
    <div id="appMessage" class="msg-hide"></div>

    <!-- Star/Constellation Canvas -->
    <canvas id="particleCanvas"></canvas>

    <div id="uploadLoader" class="fixed inset-0 bg-black/80 z-[20000] hidden flex-col items-center justify-center">
        <div class="pulse-dot text-blue-500 mb-4"></div>
        <p class="text-white font-bold text-[10px]">MEMPROSES DATA...</p>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="flex flex-col items-center justify-center">
        <div class="absolute top-6 right-6 flex items-center gap-4">
            <a id="downloadBtn" href="#" download class="text-white text-2xl hover:text-blue-400 transition-colors">
                <i class="fas fa-download"></i>
            </a>
            <button onclick="window.closeImagePreview()" class="text-white text-3xl hover:text-rose-400 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <img id="previewImage" src="" alt="Preview" class="max-w-full max-h-[80vh] rounded-xl">
        <div id="fileInfoLabel" class="mt-4 flex flex-col items-center gap-1">
            <p id="previewName" class="text-slate-400 text-[10px] font-bold uppercase"></p>
            <p id="nonImageIndicator" class="text-blue-400 text-[9px] font-black uppercase hidden tracking-widest">Klik ikon download untuk melihat file</p>
        </div>
    </div>

    <!-- Status Cloud (Pojok Kanan Bawah) -->
    <div id="syncIndicator" class="status-pill state-offline">
        <div class="pulse-dot"></div>
        <span id="syncText">Cloud Offline</span>
    </div>

    <header id="mainHeader" class="sticky top-0 z-50 bg-[#050810]/90 backdrop-blur-xl p-4 sm:p-5 header-clean">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
            
            <!-- Kiri: Akun & Notifikasi -->
            <div class="flex items-center gap-4 w-full md:w-1/3 justify-center md:justify-start">
                <div id="userInfo"></div>
                <div id="notifWrapper" class="flex flex-col items-start gap-1 hidden">
                    <div class="flex items-center gap-2">
                        <button id="notifStatusBtn" onclick="window.requestNotifPermission()" class="text-[10px] font-black uppercase tracking-widest flex items-center gap-1 transition-colors notif-prompt">
                            <i id="notifIcon" class="fas fa-bell"></i> <span id="notifText">Izin?</span>
                        </button>
                        <button onclick="window.testNotification()" class="text-[9px] text-slate-500 font-bold uppercase border border-white/10 px-2 py-0.5 rounded-md hover:bg-white/5">Tes Notif</button>
                    </div>
                    <span class="text-[8px] text-blue-500 font-black uppercase tracking-widest">Reminder: 03:30 WITA</span>
                </div>
            </div>

            <!-- Tengah: Logo Navigasi (Petir) -->
            <div id="headerBrand" class="hidden flex flex-col items-center w-full md:w-1/3 text-center">
                <div class="flex items-center gap-3 justify-center">
                    <span class="text-blue-500 text-xl sm:text-2xl"><i class="fas fa-bolt"></i></span>
                    <h1 class="text-xl sm:text-2xl font-black text-white uppercase">Disipline Tracker</h1>
                </div>
                <p id="currentSelectionLabel" class="text-[11px] text-blue-400 font-bold uppercase tracking-[2px] mt-1">01 JAN 2026</p>
            </div>

            <!-- Kanan: Kontrol Kalender -->
            <div id="navWrapper" class="hidden flex items-center justify-center md:justify-end gap-3 w-full md:w-1/3">
                <select id="monthSelect" onchange="window.updateCalendarView()"></select>
                <select id="yearSelect" onchange="window.updateCalendarView()"></select>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-8 pb-24">
        
        <!-- Motivasi Harian -->
        <div class="mb-10 text-center px-4">
            <p id="quoteText" class="text-sm sm:text-base text-slate-400 italic font-medium leading-relaxed max-w-2xl mx-auto">"Memuat motivasi..."</p>
        </div>

        <!-- Bagian Akses -->
        <div id="loginSection" class="login-frame">
            <div id="loginOverlay" class="glass-card p-10 rounded-[2.5rem] text-center shadow-2xl">
                <!-- Brand Spotlight dengan Logo Petir -->
                <div class="flex flex-col items-center mb-10">
                    <div class="w-16 h-16 bg-blue-500/10 rounded-3xl flex items-center justify-center border border-blue-500/20 mb-4 shadow-lg shadow-blue-500/5">
                        <i class="fas fa-bolt text-3xl text-blue-500"></i>
                    </div>
                    <h2 class="text-2xl sm:text-4xl font-black text-white uppercase tracking-tighter mb-2">Disipline Tracker</h2>
                    <p class="text-[10px] sm:text-[12px] text-blue-400 font-bold uppercase tracking-[2px] opacity-80">
                        Pantau Progres Harian Kamu Untuk Performa Maksimal
                    </p>
                </div>

                <div class="h-px bg-white/5 w-full mb-8"></div>

                <i class="fas fa-user-lock text-3xl text-slate-500 mb-6 opacity-40"></i>
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Akses Terkunci</h3>
                <p class="text-xs text-slate-500 mb-8 max-w-md mx-auto leading-relaxed">Pilih cara masuk untuk mulai mencatat progres disiplin kamu hari ini.</p>
                
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button onclick="window.loginWithGoogle()" class="w-full sm:w-auto bg-white text-black text-xs font-black uppercase px-8 py-3.5 rounded-full flex items-center justify-center gap-3 shadow-xl hover:scale-105 hover:bg-slate-100 active:scale-95 transition-all duration-300">
                        <i class="fab fa-google text-lg"></i> Login Google ( Berbagai Device )
                    </button>
                    <button onclick="window.loginAsGuest()" class="w-full sm:w-auto bg-white/10 text-white text-xs font-black uppercase px-8 py-3.5 rounded-full border border-white/10 hover:bg-white/20 hover:scale-105 active:scale-95 transition-all duration-300">
                        Masuk sebagai Guest (1 Device)
                    </button>
                </div>
            </div>
        </div>

        <!-- Area Konten Tracker -->
        <div id="dayTrackerArea" class="hidden opacity-0 transition-all duration-700">
            <div class="glass-card p-6 sm:p-10 rounded-[2.5rem] mb-14 shadow-2xl">
                <div class="grid grid-cols-7 gap-3 sm:gap-5 text-center mb-6 font-black text-slate-500 text-[11px] uppercase tracking-widest">
                    <span>Min</span><span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-3 sm:gap-5"></div>
            </div>

            <div id="dayHeader" class="flex flex-col sm:flex-row items-center sm:items-end justify-between mb-12 px-2 gap-6">
                <div class="text-center sm:text-left">
                    <div id="fastingBadgeContainer"></div>
                    <h2 id="dayFullLabel" class="text-3xl sm:text-4xl font-black text-white leading-tight">...</h2>
                    <div class="flex items-center justify-center sm:justify-start gap-4 mt-4">
                        <span id="sportTargetLabel" class="text-[11px] bg-blue-500/10 text-blue-400 px-4 py-2 rounded-full font-bold uppercase border border-blue-500/20 tracking-wider">...</span>
                    </div>
                </div>
                <div class="text-center sm:text-right bg-white/5 p-5 rounded-[2rem] border border-white/5 min-w-[140px] shadow-xl">
                    <span id="dayScore" class="text-5xl font-black text-emerald-400 leading-none">0%</span>
                    <p class="text-[10px] text-slate-500 uppercase font-black tracking-[2px] mt-2">Daily Progress</p>
                </div>
            </div>

            <div class="mb-14">
                <div class="flex items-center gap-4 mb-8 px-2">
                    <div class="h-px bg-blue-500/30 flex-1"></div>
                    <h3 class="text-[11px] font-black text-blue-500 uppercase tracking-[5px]">Jadwal Utama</h3>
                    <div class="h-px bg-blue-500/30 flex-1"></div>
                </div>
                <div id="taskList" class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8"></div>
            </div>

            <div class="mt-20">
                <div class="flex items-center gap-4 mb-8 px-2">
                    <div class="h-px bg-emerald-500/30 flex-1"></div>
                    <h3 class="text-[11px] font-black text-emerald-500 uppercase tracking-[5px]">Rutin & Ibadah</h3>
                    <div class="h-px bg-emerald-500/30 flex-1"></div>
                </div>
                <div id="extraTaskList" class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="max-w-6xl mx-auto">
            <p class="font-black text-[12px] tracking-[3px] text-white/80">Â© 2026 DISIPLINE TRACKER | ALL RIGHTS RESERVED</p>
            <p class="mt-3 opacity-40 font-bold uppercase text-[10px] tracking-widest leading-loose">
                DIRANCANG UNTUK PERFORMA TINGGI & KEDISPLINAN MUTLAK<br>
                SINKRONISASI CLOUD OTOMATIS ANTAR PERANGKAT
            </p>
        </div>
    </footer>

    <!-- Hidden Input for Files -->
    <input type="file" id="globalFileInput" class="hidden" multiple accept="image/*,.pdf,.txt">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- 1. SPACE CONSTELLATION CLASS ---
        class Particle {
            constructor(canvasWidth, canvasHeight) {
                this.x = Math.random() * canvasWidth;
                this.y = Math.random() * canvasHeight;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 0.6 - 0.3;
                this.speedY = Math.random() * 0.6 - 0.3;
            }
            update(canvasWidth, canvasHeight) {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > canvasWidth) this.x = 0; else if (this.x < 0) this.x = canvasWidth;
                if (this.y > canvasHeight) this.y = 0; else if (this.y < 0) this.y = canvasHeight;
            }
            draw(ctx) {
                ctx.fillStyle = 'rgba(59, 130, 246, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // --- 2. CORE UTILITIES ---
        window.formatTime = (ms) => {
            if (ms <= 0) return "00:00";
            const s = Math.floor(ms / 1000);
            const hrs = Math.floor(s / 3600);
            const mins = Math.floor((s % 3600) / 60);
            const secs = s % 60;
            return `${hrs > 0 ? hrs + ':' : ''}${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        window.showMessage = (msg) => {
            const el = document.getElementById('appMessage');
            if (!el) return;
            el.innerText = msg;
            el.classList.remove('msg-hide');
            setTimeout(() => el.classList.add('msg-hide'), 3000);
        };

        window.updateSyncUI = function() {
            const indicator = document.getElementById('syncIndicator'), syncText = document.getElementById('syncText');
            if (!indicator || !syncText) return;
            if (navigator.onLine && auth.currentUser) { indicator.className = 'status-pill state-online'; syncText.innerText = "Cloud Online"; }
            else { indicator.className = 'status-pill state-offline'; syncText.innerText = "Cloud Offline"; }
        };

        window.updateNotifUI = function(permission) {
            const btn = document.getElementById('notifStatusBtn'), text = document.getElementById('notifText'), icon = document.getElementById('notifIcon');
            if (!btn || !text || !icon) return;
            btn.className = "text-[10px] font-black uppercase tracking-widest flex items-center gap-1 transition-colors p-1 rounded-lg border border-transparent";
            if (permission === "granted") { btn.classList.add("notif-active"); text.innerText = "Aktif"; icon.className = "fas fa-bell"; }
            else if (permission === "denied") { btn.classList.add("notif-blocked"); text.innerText = "Akses Diblokir"; icon.className = "fas fa-bell-slash"; }
            else { btn.classList.add("notif-prompt"); text.innerText = "Izin?"; icon.className = "fas fa-bell"; }
        };

        // --- 3. CONFIG & STATE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6eXPEfB8aonq7M0c6pU4sVPlGoRJtYCQ",
            authDomain: "tracker-2026-4bbd9.firebaseapp.com",
            projectId: "tracker-2026-4bbd9",
            storageBucket: "tracker-2026-4bbd9.firebasestorage.app",
            messagingSenderId: "634119648342",
            appId: "1:634119648342:web:35aff0729cdcb37dcc37f7"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const trackerId = "discipline-tracker-2026";
        try { enableIndexedDbPersistence(db); } catch(e) {}

        let dayUnsubscribe = null;
        let selectedDate = new Date(2026, 0, 1);
        let cloudData = {};
        let activeItemIdForUpload = null;
        let lastNotifDate = null;
        window.openTimerPanels = {};

        const yearlyQuotes = [
            "Disipline adalah jembatan antara target dan pencapaian.",
            "Waktu kamu terbatas, jangan sia-siakan untuk hal yang nggak guna.",
            "Kemenangan dimulai dari jam 03:30 pagi.",
            "Fokus adalah kekuatan kamu, asah terus setiap detik.",
            "Tahun 2026 adalah tahun pembuktian diri kamu, bro.",
            "Jangan biarkan rasa malas mencuri masa depan kamu.",
            "Lakukan hari ini apa yang orang lain tunda.",
            "Disiplin diri adalah bentuk tertinggi dari rasa cinta diri.",
            "Konsistensi lebih penting daripada intensitas sesaat.",
            "Terus melangkah, meskipun langkah itu kecil."
        ];

        // --- 4. ANIMATION SYSTEM ---
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let mouseX = -1000, mouseY = -1000;
        let isUserLoggedIn = false;

        function initParticles() {
            particles = [];
            let count = (canvas.width * canvas.height) / 10000;
            for (let i = 0; i < count; i++) particles.push(new Particle(canvas.width, canvas.height));
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!isUserLoggedIn) {
                for (let i = 0; i < particles.length; i++) {
                    particles[i].update(canvas.width, canvas.height);
                    particles[i].draw(ctx);
                    for (let j = i; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const dmx = particles[i].x - mouseX;
                        const dmy = particles[i].y - mouseY;
                        const mouseDistance = Math.sqrt(dmx * dmx + dmy * dmy);
                        if (distance < 100 && mouseDistance < 150) {
                            ctx.strokeStyle = `rgba(59, 130, 246, ${1 - (distance / 100)})`;
                            ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke();
                        }
                    }
                }
            }
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); });
        document.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });
        document.addEventListener('touchmove', (e) => { if(e.touches.length) { mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; } });

        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        initParticles(); animateParticles();

        // --- 5. ACTIONS ---
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); } };
        window.loginAsGuest = async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } };
        window.logout = async () => { if(confirm("Keluar dari aplikasi?")) await signOut(auth); };

        window.setupRealtimeSync = function() {
            if (!auth.currentUser) return;
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            if (dayUnsubscribe) dayUnsubscribe();
            dayUnsubscribe = onSnapshot(doc(db, 'artifacts', trackerId, 'users', auth.currentUser.uid, 'calendar', docId), (snap) => {
                cloudData = snap.exists() ? snap.data() : {};
                window.renderDayTracker();
            }, (err) => { console.error(err); window.updateSyncUI(); });
            window.updateCalendarView();
        };

        async function saveToFirestore() { 
            if (!auth.currentUser) return; 
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            await setDoc(doc(db, 'artifacts', trackerId, 'users', auth.currentUser.uid, 'calendar', docId), cloudData); 
        }

        // --- 6. RENDER ENGINE ---
        window.updateCalendarView = function() {
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect'), grid = document.getElementById('calendarGrid');
            if (!yS || !mS || !grid) return;
            const year = parseInt(yS.value), month = parseInt(mS.value);
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const dayEl = document.createElement('div');
                const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                dayEl.className = `calendar-day glass-card ${isSelected ? 'active' : ''}`;
                dayEl.innerText = d;
                dayEl.onclick = () => { selectedDate = new Date(year, month, d); window.setupRealtimeSync(); };
                grid.appendChild(dayEl);
            }
        };

        window.renderDayTracker = function() {
            const ui = { full: document.getElementById('dayFullLabel'), quote: document.getElementById('quoteText'), sport: document.getElementById('sportTargetLabel'), fasting: document.getElementById('fastingBadgeContainer'), score: document.getElementById('dayScore') };
            if (!ui.full || !ui.quote) return;
            const isFri = selectedDate.getDay() === 5, mNum = selectedDate.getMonth(), dNum = selectedDate.getDate();
            const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const dNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            ui.full.innerText = `${dNames[selectedDate.getDay()]}, ${dNum} ${mNames[mNum]} ${selectedDate.getFullYear()}`;
            ui.quote.innerText = `"${yearlyQuotes[(dNum + mNum * 31) % yearlyQuotes.length]}"`;
            const sched = { 1:{type:"Gowes", val:25}, 2:{type:"Gowes", val:25}, 3:{type:"Run", val:5}, 4:{type:"Gowes", val:30}, 5:{type:"Gowes", val:20}, 6:{type:"Run", val:5}, 0:{type:"Rest", val:0} }[selectedDate.getDay()];
            const sportGoal = sched.type === "Rest" ? "ðŸ›Œ Total Rest" : (sched.type === "Run" ? `ðŸƒ Lari ${5 + Math.floor(mNum / 3)} KM` : `ðŸš´ Gowes ${sched.val} KM`);
            if(ui.sport) ui.sport.innerText = sportGoal;
            const ramStart = new Date(2026, 1, 18), ramEnd = new Date(2026, 2, 19);
            const fType = (selectedDate >= ramStart && selectedDate <= ramEnd) ? "Ramadhan" : (selectedDate.getDay() === 1 ? "Senin" : (selectedDate.getDay() === 4 ? "Kamis" : null));
            if(ui.fasting) ui.fasting.innerHTML = fType ? `<div class="fasting-alert">Puasa ${fType}</div>` : '';

            const routine = [
                { id: "english", time: "03:30", task: "Belajar Bahasa Inggris", icon: "fa-language", duration: 30 * 60000 },
                { id: "subuh", time: "04:15", task: "Bangun & Sholat Subuh", icon: "fa-mosque", noTimer: true },
                { id: "muscle_subuh", time: "05:00", task: "Muscle Up & Pull Up", icon: "fa-dumbbell", duration: 20 * 60000 },
                { id: "sport", time: "05:50", task: "Olahraga: " + sportGoal, icon: "fa-running", noTimer: true },
                { id: "dhuha", time: "07:45", task: "Sholat Dhuha", icon: "fa-hands-praying", noTimer: true },
                { id: "deep1", time: "08:30", task: "Deep Work Sesi 1", icon: "fa-keyboard", duration: 210 * 60000 },
                { id: "dzuhur", time: "12:00", task: "Sholat Dzuhur Berjamaah", icon: "fa-sun", noTimer: true },
                { id: "deep2", time: "13:30", task: "Deep Work Sesi 2", icon: "fa-brain", duration: 60 * 60000 },
                { id: "majelis", time: "14:30", task: "Jadwal Majelis", icon: "fa-users", fridayOnly: true, noTimer: true },
                { id: "ashar", time: "15:30", task: "Sholat Ashar Berjamaah", icon: "fa-sun", noTimer: true },
                { id: "skipping", time: "17:15", task: "Skipping Sore", icon: "fa-bolt", duration: 15 * 60000 },
                { id: "mandi", time: "17:45", task: "Mandi & Santai", icon: "fa-bath", noTimer: true },
                { id: "maghrib", time: "18:00", task: "Sholat Maghrib Berjamaah", icon: "fa-moon", noTimer: true },
                { id: "quran", time: "18:20", task: "Membaca Al-Qur'an", icon: "fa-book-quran", duration: 20 * 60000 },
                { id: "isya", time: "18:45", task: "Sholat Isya Berjamaah", icon: "fa-star", noTimer: true },
                { id: "buku", time: "19:00", task: "Baca Buku (Pomodoro)", icon: "fa-book-open", isPomo: true },
                { id: "tidur", time: "20:30", task: "Tidur Malam", icon: "fa-bed", noTimer: true }
            ];

            const extra = [ { id: "siram_pagi", task: "Menyiram Tanaman (Pagi)", icon: "fa-faucet-drip" }, { id: "siram_sore", task: "Menyiram Tanaman (Sore)", icon: "fa-faucet-drip" }, { id: "kasur", task: "Membersihkan Kasur", icon: "fa-bed" }, { id: "sapu", task: "Menyapu Rumah", icon: "fa-broom" }, { id: "piring", task: "Mencuci Piring", icon: "fa-sink" }, { id: "istigfar", task: "Istigfar 1000x", icon: "fa-comment-dots" }, { id: "taubat", task: "Sholat Taubat", icon: "fa-person-praying" }, { id: "kuku", task: "Potong Kuku", icon: "fa-scissors", specialDaysKuku: true }, { id: "cuci", task: "Cuci Pakaian", icon: "fa-shirt", fridayOnly: true } ];

            const renderItems = (list, targetId) => {
                const container = document.getElementById(targetId);
                if (!container) return 0; container.innerHTML = ''; let done = 0;
                list.forEach(item => {
                    if (item.fridayOnly && !isFri) return;
                    if (item.id === "majelis" && fType === "Ramadhan") return;
                    if (item.specialDaysKuku && ![1,4,5].includes(selectedDate.getDay())) return;
                    const itemData = cloudData[item.id] || {}, status = itemData.status || 'none';
                    if (status === 'done') done++;
                    const isTimerOpen = window.openTimerPanels[item.id];
                    let timerUI = '';
                    if (!item.noTimer && (item.duration || item.isPomo)) {
                        let rem = itemData.timerEnd ? itemData.timerEnd - Date.now() : (itemData.remainingMs || item.duration || 25*60000);
                        timerUI = `<div id="timer-panel-${item.id}" class="timer-panel" style="display: ${isTimerOpen ? 'flex' : 'none'}"><span class="timer-display">${window.formatTime(rem)}</span><div class="flex gap-4 mt-3"><button onclick="window.startCountdown('${item.id}', ${item.duration || 25*60000})" class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fas ${itemData.timerRunning ? 'fa-pause' : 'fa-play'}"></i></button><button onclick="window.stopTimer('${item.id}')" class="w-10 h-10 rounded-full bg-rose-500/20 text-rose-400 flex items-center justify-center"><i class="fas fa-stop"></i></button></div></div>`;
                    }
                    
                    let attHtml = (itemData.attachments || []).map((f, i) => `<div class="attachment-badge relative group" onclick="window.openImagePreview('${f.data}', '${f.name}')">${f.data.startsWith('data:image/') ? `<img src="${f.data}" class="attachment-preview" />` : `<i class="fas fa-file-alt"></i>`}<span class="truncate max-w-[60px] ml-1">${f.name}</span><button onclick="event.stopPropagation(); window.removeAttachment('${item.id}', ${i})" class="absolute -top-1 -right-1 bg-rose-500 text-white w-3 h-3 rounded-full text-[7px] flex items-center justify-center"><i class="fas fa-times"></i></button></div>`).join('');

                    const card = document.createElement('div');
                    card.className = 'glass-card p-5 rounded-3xl flex flex-col hover:scale-[1.01] transition-all duration-300';
                    card.innerHTML = `<div class="flex items-start justify-between"><div class="flex-1 pr-2"><div class="flex items-center gap-3 mb-2">${item.time ? `<span class="text-[9px] font-black text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded uppercase">${item.time}</span>` : ''}<i class="fas ${item.icon} text-[10px] text-slate-500"></i><h3 class="text-[13px] font-bold ${status === 'done' ? 'task-done-text' : 'text-slate-100'}">${item.task}</h3></div><textarea id="note-${item.id}" placeholder="Catatan kamu..." class="note-input w-full mt-1 p-2 rounded-xl min-h-[40px] resize-none">${itemData.note || ''}</textarea><div class="flex flex-wrap gap-2 mt-2">${attHtml}</div><div class="flex gap-4 mt-3"><button onclick="window.triggerUpload('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-paperclip"></i> Berkas</button>${!item.noTimer && (item.duration || item.isPomo) ? `<button onclick="window.toggleTimerPanel('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-clock"></i> Timer</button>` : ''}</div>${timerUI}</div><div class="flex flex-col gap-2 ml-2"><button onclick="window.updateStatus('${item.id}', '${status === 'done' ? 'none' : 'done'}')" class="w-10 h-10 rounded-2xl flex items-center justify-center status-btn ${status === 'done' ? 'status-done' : 'status-none'}"><i class="fas fa-check"></i></button><button onclick="window.updateStatus('${item.id}', '${status === 'fail' ? 'none' : 'fail'}')" class="w-10 h-10 rounded-2xl flex items-center justify-center status-btn ${status === 'fail' ? 'status-fail' : 'status-none'}"><i class="fas fa-times"></i></button></div></div>`;
                    card.querySelector(`#note-${item.id}`).onblur = (e) => window.updateNote(item.id, e.target.value);
                    container.appendChild(card);
                });
                return done;
            };
            const mD = renderItems(routine, 'taskList');
            const eD = renderItems(extra, 'extraTaskList');
            if(ui.score) ui.score.innerText = Math.round(((mD + eD) / (document.querySelectorAll('#taskList .glass-card, #extraTaskList .glass-card').length || 1)) * 100) + '%';
        };

        // --- 7. NOTIFICATION HANDLERS ---
        window.requestNotifPermission = () => { 
            if (!("Notification" in window)) { window.showMessage("Browser tidak mendukung notifikasi."); return; }
            Notification.requestPermission().then(p => { 
                window.updateNotifUI(p); 
                if (p === "granted") {
                    window.showMessage("Notifikasi Aktif!");
                    const opt = { body: "Konfirmasi: Notifikasi kamu sudah aktif.", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg" };
                    if ('serviceWorker' in navigator) navigator.serviceWorker.ready.then(reg => reg.showNotification("Disipline Tracker", opt));
                    new Notification("Disipline Tracker", opt);
                }
            }); 
        };

        window.testNotification = () => { 
            if (Notification.permission === "granted") { 
                window.showMessage("Mengirim Notifikasi Tes...");
                const title = "ðŸ† DISIPLINE TEST";
                const opt = { 
                    body: "Notifikasi Berhasil Terkirim!", 
                    icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg",
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                };
                try { new Notification(title, opt); } catch(e) {}
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(reg => {
                        if (reg) reg.showNotification(title, opt);
                    });
                }
                if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]); 
            } else { window.showMessage("Izinkan notif dulu (klik ikon lonceng)."); } 
        };

        window.toggleTimerPanel = (id) => { window.openTimerPanels[id] = !window.openTimerPanels[id]; window.renderDayTracker(); };
        window.startCountdown = (id, d) => { const t = cloudData[id] || {}; if (t.timerRunning) { t.timerRunning = false; t.remainingMs = (t.timerEnd || 0) - Date.now(); } else { t.timerRunning = true; t.timerEnd = Date.now() + (t.remainingMs || d); } cloudData[id] = t; saveToFirestore(); window.renderDayTracker(); };
        window.stopTimer = (id) => { cloudData[id] = { ...cloudData[id], timerRunning: false, timerEnd: null, remainingMs: null }; saveToFirestore(); window.renderDayTracker(); };
        window.updateStatus = async (id, s) => { cloudData[id] = { ...cloudData[id], status: s }; window.renderDayTracker(); saveToFirestore(); };
        window.updateNote = async (id, n) => { if (cloudData[id]?.note === n) return; cloudData[id] = { ...cloudData[id], note: n }; saveToFirestore(); };
        
        window.triggerUpload = (id) => { activeItemIdForUpload = id; document.getElementById('globalFileInput').click(); };
        window.removeAttachment = async (id, i) => { if(cloudData[id]?.attachments) { cloudData[id].attachments.splice(i, 1); window.renderDayTracker(); saveToFirestore(); } };
        window.openImagePreview = (data, name) => { 
            const m = document.getElementById('imagePreviewModal'), img = document.getElementById('previewImage'), n = document.getElementById('previewName'), dBtn = document.getElementById('downloadBtn'), nonImg = document.getElementById('nonImageIndicator'); 
            dBtn.href = data; dBtn.download = name;
            if (data.startsWith('data:image/')) { img.src = data; img.style.display = 'block'; nonImg.classList.add('hidden'); } 
            else { img.style.display = 'none'; nonImg.classList.remove('hidden'); } 
            n.innerText = name; m.style.display = 'flex'; 
        };
        window.closeImagePreview = () => { document.getElementById('imagePreviewModal').style.display = 'none'; };

        // --- 8. PWA & BOOTSTRAP ---
        const setupPWA = async () => {
            const manifest = {
                "name": "Disipline Tracker 2026",
                "short_name": "Tracker",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#050810",
                "theme_color": "#050810",
                "icons": [{
                    "src": "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg",
                    "sizes": "731x731",
                    "type": "image/jpeg"
                }]
            };
            const manifestURI = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
            document.getElementById('pwa-manifest').setAttribute('href', manifestURI);

            if ('serviceWorker' in navigator) {
                try {
                    const swCode = `
                        self.addEventListener('install', e => self.skipWaiting());
                        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                        self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => {})));
                    `;
                    const swBlob = new Blob([swCode], {type: 'application/javascript'});
                    await navigator.serviceWorker.register(URL.createObjectURL(swBlob));
                } catch(e) {}
            }
        };

        setInterval(() => {
            window.updateSyncUI();
            let redraw = false;
            Object.keys(cloudData).forEach(id => { if (cloudData[id].timerRunning) { redraw = true; let rem = cloudData[id].timerEnd - Date.now(); if (rem <= 0) { if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]); cloudData[id].timerRunning = false; saveToFirestore(); } } });
            if (redraw) window.renderDayTracker();
            const now = new Date();
            const witaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Makassar"}));
            if (witaTime.getHours() === 3 && witaTime.getMinutes() === 30 && lastNotifDate !== witaTime.toDateString()) { 
                if (Notification.permission === "granted") { 
                    const opt = { body: "Bangun! Sesi Inggris dimulai!", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg", requireInteraction: true };
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.getRegistration().then(reg => {
                            if (reg) reg.showNotification("ðŸ† EKSEKUSI!", opt);
                            else new Notification("ðŸ† EKSEKUSI!", opt);
                        });
                    } else { new Notification("ðŸ† EKSEKUSI!", opt); }
                } 
                lastNotifDate = witaTime.toDateString(); 
            }
        }, 1000);

        window.addEventListener('load', async () => {
            setupPWA();
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect');
            if(yS && mS) {
                for(let y=2026; y<=2030; y++) { let o = document.createElement('option'); o.value = y; o.innerText = y; yS.appendChild(o); }
                const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                mNames.forEach((m, i) => { let o = document.createElement('option'); o.value = i; o.innerText = m; mS.appendChild(o); });
                yS.value = selectedDate.getFullYear(); mS.value = selectedDate.getMonth();
            }

            onAuthStateChanged(auth, (user) => {
                const area = document.getElementById('dayTrackerArea'), overlay = document.getElementById('loginOverlay'), info = document.getElementById('userInfo'), wrapper = document.getElementById('notifWrapper'), loginSec = document.getElementById('loginSection'), hBrand = document.getElementById('headerBrand'), navWrap = document.getElementById('navWrapper'), hMain = document.getElementById('mainHeader');
                if (user) {
                    isUserLoggedIn = true; area.classList.remove('hidden'); setTimeout(() => area.classList.remove('opacity-0'), 10); 
                    if(loginSec) loginSec.classList.add('hidden'); 
                    if(hBrand) hBrand.classList.remove('hidden'); if(navWrap) navWrap.classList.remove('hidden'); if(hMain) hMain.classList.remove('header-clean');
                    overlay.classList.add('hidden'); wrapper.classList.remove('hidden');
                    const statusText = user.isAnonymous ? "MODE GUEST (1 DEVICE)" : user.displayName.split(' ')[0];
                    const statusColor = user.isAnonymous ? "text-yellow-400" : "text-emerald-400";
                    info.innerHTML = `<div class="flex items-center gap-2">${user.photoURL ? `<img src="${user.photoURL}" class="w-8 h-8 rounded-full border border-white/20">` : `<i class="fas fa-user-circle text-white text-2xl"></i>`}<span class="text-[10px] font-black uppercase ${statusColor}">${statusText}</span><button onclick="window.logout()" class="text-[9px] text-rose-500 font-bold ml-2">Logout</button></div>`;
                    window.setupRealtimeSync();
                } else {
                    isUserLoggedIn = false; area.classList.add('hidden', 'opacity-0'); 
                    if(loginSec) loginSec.classList.remove('hidden'); 
                    if(hBrand) hBrand.classList.add('hidden'); if(navWrap) navWrap.classList.add('hidden'); if(hMain) hMain.classList.add('header-clean');
                    overlay.classList.remove('hidden'); wrapper.classList.add('hidden');
                    info.innerHTML = ``; initParticles(); 
                }
                window.updateSyncUI();
            });

            document.getElementById('globalFileInput').onchange = async (e) => {
                const files = Array.from(e.target.files); if (!files.length || !activeItemIdForUpload) return;
                document.getElementById('uploadLoader').classList.remove('hidden'); document.getElementById('uploadLoader').classList.add('flex');
                const atts = cloudData[activeItemIdForUpload]?.attachments || [];
                for (let f of files) {
                    try {
                        let data = "";
                        if (f.type.startsWith('image/')) {
                            const reader = new FileReader();
                            data = await new Promise((r) => {
                                reader.readAsDataURL(f);
                                reader.onload = (ev) => {
                                    const img = new Image(); img.src = ev.target.result;
                                    img.onload = () => {
                                        const canvas = document.createElement('canvas');
                                        let w = img.width, h = img.height, max = 800;
                                        if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                                        canvas.width = w; canvas.height = h;
                                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                                        r(canvas.toDataURL('image/jpeg', 0.5));
                                    };
                                };
                            });
                        } else { if (f.size > 1024*1024) continue; data = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }); }
                        atts.push({ name: f.name, data: data });
                    } catch(e) {}
                }
                cloudData[activeItemIdForUpload] = { ...cloudData[activeItemIdForUpload], attachments: atts };
                await saveToFirestore(); window.renderDayTracker();
                document.getElementById('uploadLoader').classList.add('hidden'); document.getElementById('uploadLoader').classList.remove('flex');
                e.target.value = '';
            };
            window.updateCalendarView(); window.renderDayTracker();
            if ("Notification" in window) window.updateNotifUI(Notification.permission);
        });
    </script>
</body>
</html>
