<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Disipline Tracker">
    <meta name="theme-color" content="#050810">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- 1. Ikon Browser (Tab Laptop) -->
    <link rel="icon" type="image/png" href="icon_transparent_blue_text-removebg-preview.png">
    
    <!-- 2. Ikon Apple (iOS) -->
    <link rel="apple-touch-icon" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.png">
    
    <!-- 3. Manifest Fisik (Wajib untuk WebAPK Android) -->
    <link rel="manifest" href="manifest.json">

    <title>Disipline Tracker 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050810;
            color: #e2e8f0;
            letter-spacing: -0.01em;
            overscroll-behavior-y: contain;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #050810; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .status-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .status-none { background-color: #1e293b; color: #94a3b8; }
        .status-done { background-color: #3b82f6 !important; color: white !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .status-fail { background-color: #ef4444 !important; color: white !important; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.2s;
            font-size: 0.75rem;
            color: #64748b;
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .status-pill {
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.05);
        }

        #syncIndicator { position: fixed; bottom: 25px; right: 25px; z-index: 100; transition: all 0.3s ease; }
        .state-online { background: #064e3b; color: #34d399; }
        .state-offline { background: #450a0a; color: #f87171; }

        .pulse-dot { width: 6px; height: 6px; border-radius: 50%; background-color: currentColor; position: relative; }
        .pulse-dot::after {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background-color: currentColor; animation: pulse 1.5s infinite; left: 0; top: 0;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        /* Notification Status Colors - EMERALD */
        .notif-active { color: #10b981 !important; } 
        .notif-prompt { color: #f59e0b !important; } 
        .notif-blocked { color: #ef4444 !important; } 

        .note-input {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.1);
            color: #f1f5f9;
            font-size: 11px;
            transition: border-color 0.3s;
        }
        .note-input:focus { border-color: rgba(59, 130, 246, 0.5); outline: none; }

        .timer-panel { 
            background: rgba(15, 23, 42, 0.95); 
            border: 1px solid rgba(59, 130, 246, 0.3); 
            border-radius: 16px; 
            padding: 16px; 
            margin-top: 12px; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .timer-display { 
            font-family: 'Courier New', Courier, monospace; 
            font-weight: 900; 
            color: #60a5fa; 
            font-size: 1.75rem; 
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }

        #imagePreviewModal {
            display: none; position: fixed; inset: 0; z-index: 12000;
            background: rgba(0,0,0,0.95); padding: 20px;
            flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        footer { border-top: 1px solid rgba(255, 255, 255, 0.05); text-align: center; padding: 40px 20px; color: #64748b; font-size: 10px; font-weight: 700; letter-spacing: 1px; line-height: 1.6; }

        .custom-select-wrapper { position: relative; min-width: 120px; flex: 1; }
        .custom-select-wrapper::after {
            content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; right: 18px; top: 50%; transform: translateY(-50%);
            color: #3b82f6; pointer-events: none; font-size: 10px;
        }

        select { 
            appearance: none; -webkit-appearance: none;
            background-color: rgba(30, 41, 59, 0.6); 
            color: #f1f5f9; 
            border: 1px solid rgba(59, 130, 246, 0.1); 
            padding: 14px 30px 14px 20px; 
            border-radius: 14px; 
            cursor: pointer; outline: none; 
            font-size: 12px; font-weight: 800; width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase; letter-spacing: 1px;
            text-align: center; text-align-last: center;
        }

        .login-complex-container { position: relative; z-index: 50; width: 100%; max-width: 400px; margin: 0 auto; }
        
        .login-card-complex {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.9) 0%, rgba(5, 8, 16, 0.95) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 24px;
            padding: 2px; position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(59, 130, 246, 0.1);
        }

        .login-scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            opacity: 0.5; animation: scanLogin 3s linear infinite;
        }
        @keyframes scanLogin { 0% { transform: translateY(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(400px); opacity: 0; } }

        .login-inner { background: #0b101e; border-radius: 22px; padding: 40px 30px; position: relative; z-index: 2; }

        .login-btn-google {
            background: #fff; color: #000; width: 100%; padding: 16px; border-radius: 12px;
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1); font-size: 13px;
        }
        .login-btn-google:active { transform: scale(0.98); }

        .login-btn-guest {
            background: transparent; color: #64748b; border: 1px solid rgba(100, 116, 139, 0.3);
            width: 100%; padding: 16px; border-radius: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; font-size: 11px; transition: all 0.3s;
        }
        .login-btn-guest:hover { color: #94a3b8; border-color: rgba(100, 116, 139, 0.6); background: rgba(255,255,255,0.02); }

        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        #appMessage {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            z-index: 20000; background: #2563eb; color: white;
            padding: 12px 24px; border-radius: 99px; font-size: 10px;
            font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
            pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center; max-width: 90%;
        }
        .msg-hide { opacity: 0; transform: translate(-50%, -20px); }

        #mainHeader { transition: all 0.3s ease; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .header-clean { border-bottom-color: transparent !important; background: transparent !important; }

        #backToTopBtn {
            position: fixed; bottom: 80px; right: 25px; width: 50px; height: 50px;
            background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            opacity: 0; visibility: hidden; transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #backToTopBtn.visible { opacity: 1; visibility: visible; transform: translateY(0); }

        .attachment-badge {
            background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.1);
            padding: 6px 12px 6px 6px; border-radius: 14px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .attachment-badge:hover { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); }

        .attachment-preview {
            width: 40px; height: 40px; border-radius: 10px; object-fit: cover;
            background: #0f172a; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.05);
        }

        .attachment-name {
            font-size: 10px; font-weight: 600; color: #cbd5e1;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;
        }

        .btn-remove-attachment {
            background: #ef4444; color: white; width: 18px; height: 18px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 8px; border: 2px solid #050810; position: absolute;
            top: -5px; right: -5px; opacity: 0; transition: opacity 0.2s;
        }
        .attachment-badge:hover .btn-remove-attachment { opacity: 1; }

        .task-done-text { 
            text-decoration: line-through; color: #64748b !important; 
            text-decoration-color: #3b82f6; text-decoration-thickness: 2px;
        }

        .fasting-alert { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; padding: 6px 14px; border-radius: 10px; 
            font-size: 10px; font-weight: 900; text-transform: uppercase; 
            display: inline-flex; align-items: center; gap: 6px;
            margin-bottom: 8px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            border: 1px solid rgba(255,255,255,0.1); letter-spacing: 1px;
        }
        .fasting-ramadhan { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }

        /* Install Button Pulse */
        @keyframes installPulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .install-pulse { animation: installPulse 2s infinite; }
    </style>
</head>
<body class="bg-[#050810]">

    <div id="appMessage" class="msg-hide"></div>
    
    <div id="backToTopBtn" onclick="window.scrollToTop()"><i class="fas fa-arrow-up text-lg"></i></div>
    <canvas id="particleCanvas"></canvas>

    <div id="uploadLoader" class="fixed inset-0 bg-black/80 z-[20000] hidden flex-col items-center justify-center">
        <div class="pulse-dot text-blue-500 mb-4"></div>
        <p class="text-white font-bold text-[10px]">MEMPROSES DATA...</p>
    </div>

    <!-- PWA Install Guide for iOS (Floating) -->
    <div id="iosInstallPrompt" class="hidden fixed bottom-6 left-4 right-4 z-[9000] bg-slate-900/90 backdrop-blur-xl border border-white/10 p-4 rounded-2xl shadow-2xl flex-col gap-3">
        <div class="flex justify-between items-start">
            <h3 class="text-white font-bold text-sm">Install Aplikasi</h3>
            <button onclick="document.getElementById('iosInstallPrompt').style.display='none'" class="text-slate-400"><i class="fas fa-times"></i></button>
        </div>
        <p class="text-xs text-slate-300">Untuk performa terbaik di iPhone:</p>
        <div class="flex items-center gap-2 text-xs text-slate-400">1. Klik tombol Share <i class="fas fa-share-from-square text-blue-500"></i></div>
        <div class="flex items-center gap-2 text-xs text-slate-400">2. Pilih "Add to Home Screen" <i class="fas fa-plus-square text-white"></i></div>
    </div>

    <div id="imagePreviewModal" class="flex flex-col items-center justify-center">
        <div class="absolute top-6 right-6 flex items-center gap-4">
            <a id="downloadBtn" href="#" download class="text-white text-2xl hover:text-blue-400 transition-colors"><i class="fas fa-download"></i></a>
            <button onclick="window.closeImagePreview()" class="text-white text-3xl hover:text-rose-400 transition-colors"><i class="fas fa-times"></i></button>
        </div>
        <img id="previewImage" src="" alt="Preview" class="max-w-[90%] max-h-[85vh] rounded-2xl shadow-2xl object-contain border border-white/10">
        <div id="fileInfoLabel" class="mt-6 flex flex-col items-center gap-1 text-center">
            <p id="previewName" class="text-slate-300 text-xs font-bold uppercase tracking-widest"></p>
            <p id="nonImageIndicator" class="text-blue-400 text-[9px] font-black uppercase hidden tracking-widest">Klik ikon download untuk berkas ini</p>
        </div>
    </div>

    <div id="syncIndicator" class="status-pill state-offline"><div class="pulse-dot"></div><span id="syncText">Cloud Offline</span></div>

    <header id="mainHeader" class="relative z-50 bg-[#050810]/90 backdrop-blur-xl p-4 sm:p-5 header-clean">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-8">
            <div class="flex items-center gap-5 w-full md:w-1/3 justify-center md:justify-start">
                <div id="userInfo"></div>
                <div id="notifWrapper" class="flex flex-col items-start gap-2 hidden">
                    <div class="flex items-center gap-3">
                        <button id="notifStatusBtn" onclick="window.requestNotifPermission()" class="text-[13px] sm:text-[11px] font-black uppercase tracking-widest flex items-center gap-2 transition-colors p-1 rounded-lg">
                            <i id="notifIcon" class="fas fa-bell"></i> <span id="notifText">Izin?</span>
                        </button>
                        <button onclick="window.testNotification()" class="text-[11px] sm:text-[10px] text-slate-400 font-black uppercase border border-white/10 px-4 py-1.5 rounded-full hover:bg-white/10 transition-all">Tes Notif</button>
                    </div>
                    <span class="text-[10px] sm:text-[9px] text-blue-500 font-black uppercase tracking-widest opacity-80">Reminder: 03:30 WITA</span>
                </div>
            </div>

            <div id="headerBrand" class="hidden flex flex-col items-center w-full md:w-1/3 text-center order-first md:order-none">
                <div class="flex items-center gap-3 justify-center">
                    <!-- ICON PETIR -->
                    <span class="text-blue-500 text-2xl sm:text-3xl"><i class="fas fa-bolt"></i></span>
                    <h1 class="text-xl sm:text-2xl font-black text-white uppercase tracking-tighter">Disipline Tracker</h1>
                </div>
                <p id="currentSelectionLabel" class="text-xs text-blue-400 font-bold uppercase tracking-[2px] mt-1 text-center">01 JAN 2026</p>
            </div>

            <div id="navWrapper" class="hidden flex flex-row items-center justify-center md:justify-end gap-4 w-full md:w-1/3">
                <!-- INSTALL BUTTON FOR PWA -->
                <button id="installAppBtn" onclick="window.installPWA()" class="hidden bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider shadow-lg flex items-center gap-2 install-pulse">
                    <i class="fas fa-download"></i> Install App
                </button>

                <div class="custom-select-wrapper">
                    <select id="monthSelect" onchange="window.updateCalendarView(true)"></select>
                </div>
                <div class="custom-select-wrapper">
                    <select id="yearSelect" onchange="window.updateCalendarView(true)"></select>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-8 pb-24">
        <div class="mb-10 text-center px-4">
            <p id="quoteText" class="text-sm sm:text-base text-slate-400 italic font-medium leading-relaxed max-w-2xl mx-auto">"Memuat motivasi harian kamu..."</p>
        </div>

        <div id="loginSection" class="login-complex-container mt-10">
            <div class="login-card-complex">
                <div class="login-scan-line"></div>
                <div class="login-inner text-center">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-500/10 rounded-2xl mb-6 border border-blue-500/30 shadow-[0_0_30px_rgba(59,130,246,0.15)] relative overflow-hidden">
                        <i class="fas fa-fingerprint text-4xl text-blue-500 animate-pulse"></i>
                        <div class="absolute inset-0 bg-gradient-to-tr from-transparent to-blue-500/10"></div>
                    </div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter mb-2">System Access</h2>
                    <p class="text-[10px] text-blue-400 font-bold uppercase tracking-[3px] mb-8 opacity-80">Disipline Tracker 2026</p>
                    <div class="space-y-4">
                        <div class="group relative">
                            <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                            <button onclick="window.loginWithGoogle()" class="relative login-btn-google"><i class="fab fa-google text-lg text-blue-600"></i><span>Login via Google</span></button>
                        </div>
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-700/50"></div></div>
                            <div class="relative flex justify-center"><span class="bg-[#0b101e] px-2 text-[9px] text-slate-500 uppercase tracking-widest font-bold">Atau</span></div>
                        </div>
                        <button onclick="window.loginAsGuest()" class="login-btn-guest"><i class="fas fa-user-secret mr-2"></i> Lanjutkan Sebagai Guest</button>
                    </div>
                    <div class="mt-8 pt-6 border-t border-slate-800/50">
                        <p class="text-[9px] text-slate-600 uppercase font-bold tracking-wider"><i class="fas fa-shield-alt mr-1"></i> Secure Connection â€¢ v2.6</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dayTrackerArea" class="hidden opacity-0 transition-all duration-700">
            <div class="glass-card p-6 sm:p-10 rounded-[2.5rem] mb-14 shadow-2xl">
                <div class="grid grid-cols-7 gap-3 sm:gap-5 text-center mb-6 font-black text-slate-500 text-[11px] uppercase tracking-widest">
                    <span>Min</span><span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-3 sm:gap-5"></div>
            </div>

            <div id="dayHeader" class="flex flex-col sm:flex-row items-center justify-between mb-12 px-2 gap-6">
                <div class="text-center w-full sm:w-auto">
                    <div id="fastingBadgeContainer" class="flex justify-center sm:justify-start mb-2"></div>
                    <h2 id="dayFullLabel" class="text-4xl sm:text-5xl font-black text-white leading-tight tracking-tight">...</h2>
                    <div class="flex items-center justify-center sm:justify-start gap-4 mt-4">
                        <span id="sportTargetLabel" class="text-[11px] bg-blue-500/10 text-blue-400 px-4 py-2 rounded-full font-bold uppercase border border-blue-500/20 tracking-wider">...</span>
                    </div>
                </div>
                <div class="text-center sm:text-right bg-emerald-500/5 p-5 rounded-[2rem] border border-emerald-500/10 min-w-[140px] shadow-xl shadow-emerald-500/10">
                    <span id="dayScore" class="text-5xl font-black text-emerald-400 leading-none drop-shadow-[0_0_15px_rgba(52,211,153,0.5)]">0%</span>
                    <p class="text-[10px] text-emerald-500/60 uppercase font-black tracking-[2px] mt-2">Daily Progress</p>
                </div>
            </div>

            <div class="mb-14">
                <div class="flex items-center gap-4 mb-8 px-2">
                    <div class="h-px bg-blue-500/30 flex-1"></div>
                    <h3 class="text-[11px] font-black text-blue-500 uppercase tracking-[5px]">Jadwal Utama</h3>
                    <div class="h-px bg-blue-500/30 flex-1"></div>
                </div>
                <div id="taskList" class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8"></div>
            </div>

            <div class="mt-20">
                <div class="flex items-center gap-4 mb-8 px-2">
                    <div class="h-px bg-emerald-500/30 flex-1"></div>
                    <h3 class="text-[11px] font-black text-emerald-500 uppercase tracking-[5px]">Rutin & Ibadah</h3>
                    <div class="h-px bg-emerald-500/30 flex-1"></div>
                </div>
                <div id="extraTaskList" class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8"></div>
            </div>
        </div>
    </main>

    <footer>
        <div class="max-w-6xl mx-auto text-center">
            <p class="font-black text-[12px] tracking-[3px] text-white/80 uppercase">Â© 2026 Disipline Tracker | All Rights Reserved</p>
            <p class="mt-3 opacity-40 font-bold uppercase text-[10px] tracking-widest leading-loose">Dirancang untuk performa tinggi & kedisplinan mutlak<br>Sinkronisasi cloud otomatis antar perangkat</p>
        </div>
    </footer>

    <input type="file" id="globalFileInput" class="hidden" multiple accept="image/*,.pdf,.txt">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        class Particle {
            constructor(canvasWidth, canvasHeight) {
                this.x = Math.random() * canvasWidth; this.y = Math.random() * canvasHeight;
                this.size = Math.random() * 2 + 1; this.speedX = Math.random() * 0.6 - 0.3; this.speedY = Math.random() * 0.6 - 0.3;
            }
            update(canvasWidth, canvasHeight) {
                this.x += this.speedX; this.y += this.speedY;
                if (this.x > canvasWidth) this.x = 0; else if (this.x < 0) this.x = canvasWidth;
                if (this.y > canvasHeight) this.y = 0; else if (this.y < 0) this.y = canvasHeight;
            }
            draw(ctx) {
                ctx.fillStyle = 'rgba(59, 130, 246, 0.8)'; ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        const yearlyQuotes = [ "Hari ke-1: Langkah kecil hari ini adalah awal dari kemenangan besar.", "Hari ke-2: Disiplin adalah jembatan antara target dan pencapaian.", "Hari ke-3: Jangan biarkan rasa malas mencuri masa depan kamu.", "Hari ke-4: Kamu jauh lebih kuat dari alasan-alasan kamu sendiri.", "Hari ke-5: Konsistensi mengalahkan intensitas yang cuma sebentar.", "Hari ke-6: Waktu kamu terbatas, jangan sia-siakan untuk hal sepele.", "Hari ke-7: Kemenangan hari ini dimulai dari bangun jam 03:30 pagi.", "Hari ke-8: Fokus adalah kekuatan kamu, asah terus setiap detik.", "Hari ke-9: Tahun 2026 adalah panggung pembuktian diri kamu, bro.", "Hari ke-10: Jangan cuma berharap, tapi mulai eksekusi sekarang!", "Hari ke-11: Lakukan hari ini apa yang orang lain tunda besok.", "Hari ke-12: Disiplin diri adalah bentuk tertinggi cinta pada diri sendiri.", "Hari ke-13: Semakin keras kamu bekerja, semakin beruntung kamu jadinya.", "Hari ke-14: Jangan berhenti saat lelah, berhenti saat kamu sudah selesai.", "Hari ke-15: Kebiasaan kamu hari ini menentukan siapa kamu di masa depan.", "Hari ke-16: Fokus pada progres, bukan cuma pada kesempurnaan.", "Hari ke-17: Setiap tetes keringat olahraga adalah investasi kesehatan.", "Hari ke-18: Pikiran yang disiplin akan menghasilkan hidup yang bahagia.", "Hari ke-19: Kegagalan terbesar adalah ketika kamu takut untuk mencoba.", "Hari ke-20: Jadilah versi terbaik dari diri kamu setiap matahari terbit.", "Hari ke-21: Rasa sakit disiplin jauh lebih ringan daripada rasa sakit penyesalan.", "Hari ke-22: Apa yang kamu tanam hari ini akan kamu panen suatu hari nanti.", "Hari ke-23: Jangan biarkan lingkungan merusak standar kedisiplinan kamu.", "Hari ke-24: Kendalikan pagi kamu, maka kamu akan mengendalikan hari kamu.", "Hari ke-25: Sukses tidak datang tiba-tiba, ia datang karena dipersiapkan.", "Hari ke-26: Belajar bahasa adalah membuka pintu dunia yang lebih luas.", "Hari ke-27: Keberanian adalah melangkah meski rasa takut masih ada.", "Hari ke-28: Berhenti membandingkan diri dengan orang lain, bandingkan dengan dirimu kemarin.", "Hari ke-29: Konsistensi adalah kunci yang membuka semua pintu sukses.", "Hari ke-30: Perubahan besar dimulai dari perubahan pola pikir." ];
        
        function getQuoteForDate(date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const dayDiff = Math.floor((date - startOfYear) / (1000 * 60 * 60 * 24));
            const backupQuotes = [ "Kesuksesan adalah totalitas dari usaha kecil yang diulang setiap hari.", "Disiplin adalah kemampuan untuk melakukan apa yang harus dilakukan.", "Jangan biarkan kemarin mengambil terlalu banyak waktu hari ini.", "Pemenang adalah pemimpi yang tidak pernah menyerah.", "Satu-satunya batasan adalah pikiran kamu sendiri.", "Kamu tidak perlu hebat untuk memulai, tapi kamu harus mulai untuk menjadi hebat.", "Kerja keras dalam diam, biarkan kesuksesan yang bersuara.", "Kesehatan adalah kekayaan pertama yang harus kamu jaga.", "Fokuslah pada solusi, bukan pada masalahnya.", "Hidup kamu adalah cerminan dari disiplin harian kamu." ];
            if (yearlyQuotes[dayDiff]) return yearlyQuotes[dayDiff];
            return backupQuotes[dayDiff % backupQuotes.length] + ` (Fokus Hari ke-${dayDiff + 1})`;
        }

        window.formatTime = (ms) => {
            if (ms <= 0) return "00:00";
            const s = Math.floor(ms / 1000); const hrs = Math.floor(s / 3600); const mins = Math.floor((s % 3600) / 60); const secs = s % 60;
            return `${hrs > 0 ? hrs + ':' : ''}${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); };
        window.showMessage = (msg) => { const el = document.getElementById('appMessage'); if (!el) return; el.innerText = msg; el.classList.remove('msg-hide'); setTimeout(() => el.classList.add('msg-hide'), 4000); };
        
        window.updateSyncUI = function() {
            const indicator = document.getElementById('syncIndicator'), syncText = document.getElementById('syncText');
            if (!indicator || !syncText) return;
            if (navigator.onLine && auth.currentUser) { indicator.className = 'status-pill state-online'; syncText.innerText = "Cloud Online"; }
            else { indicator.className = 'status-pill state-offline'; syncText.innerText = "Cloud Offline"; }
        };

        window.updateNotifUI = function(permission) {
            const btn = document.getElementById('notifStatusBtn'), text = document.getElementById('notifText'), icon = document.getElementById('notifIcon');
            if (!btn || !text || !icon) return;
            btn.classList.remove('notif-active', 'notif-prompt', 'notif-blocked');
            if (permission === "granted") { btn.classList.add("notif-active"); text.innerText = "Aktif"; icon.className = "fas fa-bell"; } 
            else if (permission === "denied") { btn.classList.add("notif-blocked"); text.innerText = "Akses Diblokir"; icon.className = "fas fa-bell-slash"; } 
            else { btn.classList.add("notif-prompt"); text.innerText = "Izin?"; icon.className = "fas fa-bell"; }
        };

        const firebaseConfig = { apiKey: "AIzaSyD6eXPEfB8aonq7M0c6pU4sVPlGoRJtYCQ", authDomain: "tracker-2026-4bbd9.firebaseapp.com", projectId: "tracker-2026-4bbd9", storageBucket: "tracker-2026-4bbd9.firebasestorage.app", messagingSenderId: "634119648342", appId: "1:634119648342:web:35aff0729cdcb37dcc37f7" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        const trackerId = "discipline-tracker-2026";
        try { enableIndexedDbPersistence(db); } catch(e) {}

        let dayUnsubscribe = null, selectedDate = new Date(2026, 0, 1), cloudData = {}, activeItemIdForUpload = null, lastNotifDate = null, isUserLoggedIn = false;
        window.openTimerPanels = {};

        const canvas = document.getElementById('particleCanvas'), ctx = canvas.getContext('2d');
        let particles = [], mouseX = -1000, mouseY = -1000;

        function initParticles() { particles = []; let count = (canvas.width * canvas.height) / 10000; for (let i = 0; i < count; i++) particles.push(new Particle(canvas.width, canvas.height)); }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!isUserLoggedIn) {
                for (let i = 0; i < particles.length; i++) {
                    particles[i].update(canvas.width, canvas.height); particles[i].draw(ctx);
                    for (let j = i; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x, dy = particles[i].y - particles[j].y, distance = Math.sqrt(dx * dx + dy * dy);
                        const dmx = particles[i].x - mouseX, dmy = particles[i].y - mouseY, mouseDistance = Math.sqrt(dmx * dmx + dmy * dmy);
                        if (distance < 100 && mouseDistance < 150) { ctx.strokeStyle = `rgba(59, 130, 246, ${1 - (distance / 100)})`; ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke(); }
                    }
                }
            }
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); });
        document.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });
        document.addEventListener('touchmove', (e) => { if(e.touches.length) { mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; } });
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); animateParticles();

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); } };
        window.loginAsGuest = async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } };
        window.logout = async () => { 
            if(confirm("Keluar dari aplikasi?")) {
                if(dayUnsubscribe) dayUnsubscribe();
                cloudData = {};
                window.renderDayTracker();
                await signOut(auth); 
                window.location.reload(); 
            }
        };

        window.setupRealtimeSync = function() {
            if (!auth.currentUser) return;
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            if (dayUnsubscribe) dayUnsubscribe();
            dayUnsubscribe = onSnapshot(doc(db, 'artifacts', trackerId, 'users', auth.currentUser.uid, 'calendar', docId), (snap) => {
                cloudData = snap.exists() ? snap.data() : {};
                window.renderDayTracker();
            }, (err) => { console.error(err); window.updateSyncUI(); });
            window.updateCalendarView();
        };

        async function saveToFirestore() { 
            if (!auth.currentUser) return; 
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            await setDoc(doc(db, 'artifacts', trackerId, 'users', auth.currentUser.uid, 'calendar', docId), cloudData); 
        }

        window.updateCalendarView = function(isFromDropdown = false) {
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect'), grid = document.getElementById('calendarGrid');
            if (!yS || !mS || !grid) return;
            const year = parseInt(yS.value), month = parseInt(mS.value);
            if(isFromDropdown) { selectedDate = new Date(year, month, 1); window.setupRealtimeSync(); }
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const dayEl = document.createElement('div');
                const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                dayEl.className = `calendar-day glass-card ${isSelected ? 'active' : ''}`;
                dayEl.innerText = d;
                dayEl.onclick = () => { selectedDate = new Date(year, month, d); window.setupRealtimeSync(); };
                grid.appendChild(dayEl);
            }
        };

        window.renderDayTracker = function() {
            const ui = { full: document.getElementById('dayFullLabel'), sel: document.getElementById('currentSelectionLabel'), quote: document.getElementById('quoteText'), sport: document.getElementById('sportTargetLabel'), fasting: document.getElementById('fastingBadgeContainer'), score: document.getElementById('dayScore') };
            if (!ui.full || !ui.quote) return;
            const isFri = selectedDate.getDay() === 5, mNum = selectedDate.getMonth(), dNum = selectedDate.getDate();
            const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const dNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            
            ui.full.innerText = `${dNames[selectedDate.getDay()]}, ${dNum} ${mNames[mNum]} ${selectedDate.getFullYear()}`;
            if(ui.sel) ui.sel.innerText = `${dNum < 10 ? '0'+dNum : dNum} ${mNames[mNum].substring(0,3).toUpperCase()} ${selectedDate.getFullYear()}`;
            ui.quote.innerText = `"${getQuoteForDate(selectedDate)}"`;
            
            const ramStart = new Date(2026, 1, 18), ramEnd = new Date(2026, 2, 19), isRamadan = selectedDate >= ramStart && selectedDate <= ramEnd;
            let sportGoal = "";
            if (isRamadan) sportGoal = "ðŸš¶ Jalan Santai / Stretching (Menjelang Buka)";
            else {
                const sched = { 1:{type:"Gowes", val:25}, 2:{type:"Gowes", val:25}, 3:{type:"Run", val:5}, 4:{type:"Gowes", val:30}, 5:{type:"Gowes", val:20}, 6:{type:"Run", val:5}, 0:{type:"Rest", val:0} }[selectedDate.getDay()];
                sportGoal = sched.type === "Rest" ? "ðŸ›Œ Total Rest" : (sched.type === "Run" ? `ðŸƒ Lari ${5 + Math.floor(mNum / 3)} KM` : `ðŸš´ Gowes ${sched.val} KM`);
            }
            if(ui.sport) ui.sport.innerText = sportGoal;

            let fastingLabel = "", fastingClass = "fasting-alert";
            if (isRamadan) { fastingLabel = "ðŸŒ™ Puasa Ramadhan"; fastingClass += " fasting-ramadhan"; } 
            else if (selectedDate.getDay() === 1) fastingLabel = "âœ¨ Puasa Sunnah Senin";
            else if (selectedDate.getDay() === 4) fastingLabel = "âœ¨ Puasa Sunnah Kamis";
            if(ui.fasting) ui.fasting.innerHTML = fastingLabel ? `<div class="${fastingClass}">${fastingLabel}</div>` : '';

            const routine = [
                { id: "english", time: "03:30", task: "Belajar Bahasa Inggris", icon: "fa-language", duration: 30 * 60000 },
                { id: "subuh", time: "04:15", task: "Bangun & Sholat Subuh", icon: "fa-mosque", noTimer: true },
                { id: "muscle_subuh", time: "05:00", task: "Muscle Up & Pull Up", icon: "fa-dumbbell", duration: 20 * 60000 },
                { id: "sport", time: "05:50", task: "Olahraga: " + sportGoal, icon: "fa-running", noTimer: true },
                { id: "dhuha", time: "07:45", task: "Sholat Dhuha", icon: "fa-hands-praying", noTimer: true },
                { id: "deep1", time: "08:30", task: "Deep Work Sesi 1", icon: "fa-keyboard", duration: 210 * 60000 },
                { id: "dzuhur", time: "12:00", task: "Sholat Dzuhur Berjamaah", icon: "fa-sun", noTimer: true },
                { id: "deep2", time: "13:30", task: "Deep Work Sesi 2", icon: "fa-brain", duration: 60 * 60000 },
                { id: "majelis", time: "14:30", task: "Jadwal Majelis", icon: "fa-users", fridayOnly: true, noTimer: true },
                { id: "ashar", time: "15:30", task: "Sholat Ashar Berjamaah", icon: "fa-sun", noTimer: true },
                { id: "skipping", time: "17:15", task: "Skipping Sore", icon: "fa-bolt", duration: 15 * 60000 },
                { id: "mandi", time: "17:45", task: "Mandi & Santai", icon: "fa-bath", noTimer: true },
                { id: "maghrib", time: "18:00", task: isRamadan ? "Buka Puasa & Maghrib Berjamaah" : "Sholat Maghrib Berjamaah", icon: isRamadan ? "fa-utensils" : "fa-moon", noTimer: true },
                { id: "quran", time: "18:20", task: "Membaca Al-Qur'an", icon: "fa-book-quran", duration: 20 * 60000 },
                { id: "isya", time: "18:45", task: "Sholat Isya Berjamaah", icon: "fa-star", noTimer: true },
                { id: "buku", time: "19:00", task: "Baca Buku (Pomodoro)", icon: "fa-book-open", isPomo: true },
                { id: "tidur", time: "20:30", task: "Tidur Malam", icon: "fa-bed", noTimer: true }
            ];

            const extra = [ { id: "siram_pagi", task: "Menyiram Tanaman (Pagi)", icon: "fa-faucet-drip" }, { id: "siram_sore", task: "Menyiram Tanaman (Sore)", icon: "fa-faucet-drip" }, { id: "kasur", task: "Membersihkan Kasur", icon: "fa-bed" }, { id: "sapu", task: "Menyapu Rumah", icon: "fa-broom" }, { id: "piring", task: "Mencuci Piring", icon: "fa-sink" }, { id: "istigfar", task: "Istigfar 1000x", icon: "fa-comment-dots" }, { id: "taubat", task: "Sholat Taubat", icon: "fa-person-praying" }, { id: "kuku", task: "Potong Kuku", icon: "fa-scissors", specialDaysKuku: true }, { id: "cuci", task: "Cuci Pakaian", icon: "fa-shirt", fridayOnly: true } ];

            const renderItems = (list, targetId) => {
                const container = document.getElementById(targetId);
                if (!container) return 0; container.innerHTML = ''; let done = 0;
                list.forEach(item => {
                    if (item.fridayOnly && !isFri) return;
                    if (item.specialDaysKuku && ![1,4,5].includes(selectedDate.getDay())) return;
                    if (item.id === "majelis" && isRamadan) return;

                    const itemData = cloudData[item.id] || {}, status = itemData.status || 'none';
                    if (status === 'done') done++;
                    const isTimerOpen = window.openTimerPanels[item.id];
                    let timerUI = '';
                    if (!item.noTimer && (item.duration || item.isPomo)) {
                        let rem = itemData.timerEnd ? itemData.timerEnd - Date.now() : (itemData.remainingMs || item.duration || 25*60000);
                        timerUI = `
                            <div id="timer-panel-${item.id}" class="timer-panel" style="display: ${isTimerOpen ? 'flex' : 'none'}">
                                <span class="timer-display">${window.formatTime(rem)}</span>
                                <div class="flex gap-4 mt-3">
                                    <button onclick="window.startCountdown('${item.id}', ${item.duration || 25*60000})" class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center transition-all hover:bg-blue-500/30"><i class="fas ${itemData.timerRunning ? 'fa-pause' : 'fa-play'}"></i></button>
                                    <button onclick="window.stopTimer('${item.id}')" class="w-10 h-10 rounded-full bg-rose-500/20 text-rose-400 flex items-center justify-center transition-all hover:bg-rose-500/30"><i class="fas fa-stop"></i></button>
                                </div>
                            </div>`;
                    }
                    
                    let attHtml = (itemData.attachments || []).map((f, i) => `
                        <div class="attachment-badge relative group" onclick="window.openImagePreview('${f.data}', '${f.name}')">
                            ${f.data.startsWith('data:image/') ? `<img src="${f.data}" class="attachment-preview" />` : `<i class="fas fa-file-alt text-blue-400 text-lg"></i>`}
                            <span class="attachment-name">${f.name}</span>
                            <button onclick="event.stopPropagation(); window.removeAttachment('${item.id}', ${i})" class="btn-remove-attachment"><i class="fas fa-times text-[7px]"></i></button>
                        </div>`).join('');

                    const card = document.createElement('div');
                    card.className = 'glass-card p-5 rounded-3xl flex flex-col hover:scale-[1.01] transition-all relative';
                    card.innerHTML = `<div class="flex items-start justify-between"><div class="flex-1 pr-2"><div class="flex items-center gap-3 mb-2">${item.time ? `<span class="text-[9px] font-black text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded uppercase">${item.time}</span>` : ''}<i class="fas ${item.icon} text-[10px] text-slate-500"></i><h3 class="text-[13px] font-bold ${status === 'done' ? 'task-done-text' : 'text-slate-100'}">${item.task}</h3></div><textarea id="note-${item.id}" placeholder="Catatan kamu..." class="note-input w-full mt-1 p-2 rounded-xl min-h-[40px] resize-none">${itemData.note || ''}</textarea><div class="flex flex-wrap gap-3 mt-3">${attHtml}</div><div class="flex gap-4 mt-3"><button onclick="window.triggerUpload('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-paperclip"></i> Berkas</button>${!item.noTimer && (item.duration || item.isPomo) ? `<button onclick="window.toggleTimerPanel('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-clock"></i> Timer</button>` : ''}</div>${timerUI}</div><div class="flex flex-col gap-2 ml-2"><button onclick="window.updateStatus('${item.id}', '${status === 'done' ? 'none' : 'done'}')" class="w-10 h-10 rounded-2xl flex items-center justify-center status-btn ${status === 'done' ? 'status-done' : 'status-none'}"><i class="fas fa-check"></i></button><button onclick="window.updateStatus('${item.id}', '${status === 'fail' ? 'none' : 'fail'}')" class="w-10 h-10 rounded-2xl flex items-center justify-center status-btn ${status === 'fail' ? 'status-fail' : 'status-none'}"><i class="fas fa-times"></i></button></div></div>`;
                    card.querySelector(`#note-${item.id}`).onblur = (e) => window.updateNote(item.id, e.target.value);
                    container.appendChild(card);
                });
                return done;
            };
            const mD = renderItems(routine, 'taskList'), eD = renderItems(extra, 'extraTaskList');
            if(ui.score) ui.score.innerText = Math.round(((mD + eD) / (document.querySelectorAll('#taskList .glass-card, #extraTaskList .glass-card').length || 1)) * 100) + '%';
        };

        window.requestNotifPermission = () => { 
            if (!("Notification" in window)) { window.showMessage("Browser ini tidak mendukung fitur notifikasi."); return; }
            Notification.requestPermission().then(p => { 
                window.updateNotifUI(p); if (p === "granted") {
                    window.showMessage("Beres! Notifikasi kamu sekarang sudah aktif.");
                    const opt = { body: "Konfirmasi: Notifikasi Disipline Tracker sudah aktif.", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.png" };
                    if ('serviceWorker' in navigator) navigator.serviceWorker.ready.then(reg => reg.showNotification("Disipline Tracker", opt));
                    new Notification("Disipline Tracker", opt);
                } else if (p === "denied") window.showMessage("Akses notifikasi diblokir. Harap aktifkan di pengaturan browser kamu.");
            }); 
        };

        window.testNotification = () => { 
            if (Notification.permission === "granted") { 
                window.showMessage("Sedang mengirim notifikasi uji coba...");
                const title = "ðŸ† DISIPLINE TEST", opt = { body: "Mantap! Notifikasi kamu berfungsi dengan baik.", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.png", requireInteraction: true };
                try { new Notification(title, opt); } catch(e) {}
                if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistration().then(reg => { if (reg) reg.showNotification(title, opt); });
                if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]); 
            } else if (Notification.permission === "denied") window.showMessage("Akses notifikasi diblokir. Harap aktifkan kembali di pengaturan browser kamu.");
            else window.showMessage("Harap klik ikon lonceng di atas untuk mengizinkan notifikasi."); 
        };

        window.toggleTimerPanel = (id) => { window.openTimerPanels[id] = !window.openTimerPanels[id]; window.renderDayTracker(); };
        window.startCountdown = (id, d) => { 
            const t = cloudData[id] || {}; 
            if (t.timerRunning) { t.timerRunning = false; t.remainingMs = (t.timerEnd || 0) - Date.now(); } 
            else { t.timerRunning = true; t.timerEnd = Date.now() + (t.remainingMs || d); } 
            cloudData[id] = t; saveToFirestore(); window.renderDayTracker(); 
        };
        window.stopTimer = (id) => { cloudData[id] = { ...cloudData[id], timerRunning: false, timerEnd: null, remainingMs: null }; saveToFirestore(); window.renderDayTracker(); };
        window.updateStatus = async (id, s) => { cloudData[id] = { ...cloudData[id], status: s }; window.renderDayTracker(); saveToFirestore(); };
        window.updateNote = async (id, n) => { if (cloudData[id]?.note === n) return; cloudData[id] = { ...cloudData[id], note: n }; saveToFirestore(); };
        window.triggerUpload = (id) => { activeItemIdForUpload = id; document.getElementById('globalFileInput').click(); };
        window.removeAttachment = async (id, i) => { if(cloudData[id]?.attachments) { cloudData[id].attachments.splice(i, 1); window.renderDayTracker(); saveToFirestore(); } };
        window.openImagePreview = (data, name) => { 
            const m = document.getElementById('imagePreviewModal'), img = document.getElementById('previewImage'), n = document.getElementById('previewName'), dBtn = document.getElementById('downloadBtn'), nonImg = document.getElementById('nonImageIndicator'); 
            dBtn.href = data; dBtn.download = name;
            if (data.startsWith('data:image/')) { img.src = data; img.style.display = 'block'; nonImg.classList.add('hidden'); } else { img.style.display = 'none'; nonImg.classList.remove('hidden'); } 
            n.innerText = name; m.style.display = 'flex'; 
        };
        window.closeImagePreview = () => { document.getElementById('imagePreviewModal').style.display = 'none'; };

        // --- PWA INSTALLATION LOGIC ---
        let deferredPrompt;
        const installBtn = document.getElementById('installAppBtn');
        const iosPrompt = document.getElementById('iosInstallPrompt');

        // Logic 1: Android/Chrome "Install App" Button
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // Prevent default banner
            deferredPrompt = e;
            installBtn.classList.remove('hidden'); 
            installBtn.classList.add('flex');
            
            // Enable button
            installBtn.classList.remove('cursor-not-allowed', 'opacity-50');
            installBtn.classList.add('hover:bg-blue-500', 'bg-blue-600', 'text-white');
            installBtn.classList.remove('bg-slate-700', 'text-slate-400');
            console.log("Install prompt intercepted");
        });

        window.installPWA = async () => {
            if (!deferredPrompt) {
                // Manual fallback instructions
                alert("Tekan tombol 'Install App' atau 'Add to Home Screen' di menu browser Anda.");
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log("User response to install prompt:", outcome);
            deferredPrompt = null;
            installBtn.classList.add('hidden');
        };

        // Logic 2: iOS Detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        
        if (isIOS && !isStandalone) {
            setTimeout(() => {
                if(iosPrompt) {
                    iosPrompt.classList.remove('hidden');
                    iosPrompt.classList.add('flex');
                }
            }, 3000);
        }

        window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); };
        window.onscroll = function() { const btn = document.getElementById('backToTopBtn'); if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) btn.classList.add('visible'); else btn.classList.remove('visible'); };
        
        setInterval(() => {
            window.updateSyncUI(); let redraw = false;
            Object.keys(cloudData).forEach(id => { if (cloudData[id].timerRunning) { redraw = true; let rem = cloudData[id].timerEnd - Date.now(); if (rem <= 0) { if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]); cloudData[id].timerRunning = false; cloudData[id].timerEnd = null; cloudData[id].remainingMs = null; saveToFirestore(); } } });
            if (redraw) window.renderDayTracker();
            const now = new Date(), witaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Makassar"}));
            if (witaTime.getHours() === 3 && witaTime.getMinutes() === 30 && lastNotifDate !== witaTime.toDateString()) { if (Notification.permission === "granted") { const opt = { body: "Bangun! Sesi Inggris dimulai!", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.png", requireInteraction: true }; if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistration().then(reg => { if (reg) reg.showNotification("ðŸ† EKSEKUSI!", opt); }); else new Notification("ðŸ† EKSEKUSI!", opt); } lastNotifDate = witaTime.toDateString(); }
        }, 1000);

        window.addEventListener('load', async () => {
            // Service Worker Registration for PWA (Native Mode)
            if ('serviceWorker' in navigator) {
                try {
                    // Mendaftarkan service worker sederhana
                    const swCode = `
                        self.addEventListener('install', e => self.skipWaiting());
                        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                        self.addEventListener('fetch', e => {}); // Basic fetch handler
                    `;
                    const swBlob = new Blob([swCode], {type: 'application/javascript'});
                    const swUrl = URL.createObjectURL(swBlob);
                    // Register at root scope
                    navigator.serviceWorker.register(swUrl, {scope: './'});
                } catch(e) { console.log('SW failed', e); }
            }

            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect');
            if(yS && mS) {
                for(let y=2026; y<=2030; y++) { let o = document.createElement('option'); o.value = y; o.innerText = y; yS.appendChild(o); }
                const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                mNames.forEach((m, i) => { let o = document.createElement('option'); o.value = i; o.innerText = m; mS.appendChild(o); });
                yS.value = selectedDate.getFullYear(); mS.value = selectedDate.getMonth();
            }

            onAuthStateChanged(auth, (user) => {
                const area = document.getElementById('dayTrackerArea'), info = document.getElementById('userInfo'), wrapper = document.getElementById('notifWrapper'), loginSec = document.getElementById('loginSection'), hBrand = document.getElementById('headerBrand'), navWrap = document.getElementById('navWrapper'), hMain = document.getElementById('mainHeader');
                if (user) {
                    isUserLoggedIn = true; area.classList.remove('hidden'); setTimeout(() => area.classList.remove('opacity-0'), 10); 
                    if(loginSec) loginSec.classList.add('hidden'); 
                    if(hBrand) hBrand.classList.remove('hidden'); if(navWrap) navWrap.classList.remove('hidden'); if(hMain) hMain.classList.remove('header-clean');
                    wrapper.classList.remove('hidden');
                    const statusText = user.isAnonymous ? "MODE GUEST (1 DEVICE)" : user.displayName.split(' ')[0];
                    const statusColor = user.isAnonymous ? "text-yellow-400" : "text-emerald-400";
                    info.innerHTML = `<div class="flex items-center gap-3">${user.photoURL ? `<img src="${user.photoURL}" class="w-12 h-12 rounded-full border-2 border-white/10 shadow-lg">` : `<i class="fas fa-user-circle text-white text-4xl"></i>`}<div class="flex flex-col"><span class="text-[12px] font-black uppercase tracking-wider ${statusColor}">${statusText}</span><button onclick="window.logout()" class="text-[13px] sm:text-[11px] text-rose-500 font-black uppercase text-left hover:text-rose-400 transition-colors tracking-widest mt-1">Logout</button></div></div>`;
                    window.setupRealtimeSync();
                } else {
                    // Reset UI to login state
                    isUserLoggedIn = false; area.classList.add('hidden', 'opacity-0'); 
                    if(loginSec) loginSec.classList.remove('hidden'); if(hBrand) hBrand.classList.add('hidden'); if(navWrap) navWrap.classList.add('hidden'); if(hMain) hMain.classList.add('header-clean');
                    wrapper.classList.add('hidden');
                    info.innerHTML = ``; initParticles(); 
                    cloudData = {};
                    window.renderDayTracker();
                }
                window.updateSyncUI();
            });

            document.getElementById('globalFileInput').onchange = async (e) => {
                const files = Array.from(e.target.files); if (!files.length || !activeItemIdForUpload) return;
                document.getElementById('uploadLoader').classList.remove('hidden', 'flex'); document.getElementById('uploadLoader').classList.add('flex');
                const atts = cloudData[activeItemIdForUpload]?.attachments || [];
                for (let f of files) {
                    try {
                        let data = "";
                        if (f.type.startsWith('image/')) {
                            const reader = new FileReader(); data = await new Promise((r) => { reader.readAsDataURL(f); reader.onload = (ev) => { const img = new Image(); img.src = ev.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height, max = 800; if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); r(canvas.toDataURL('image/jpeg', 0.5)); }; }; });
                        } else { if (f.size > 1024*1024) continue; data = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }); }
                        atts.push({ name: f.name, data: data });
                    } catch(e) {}
                }
                cloudData[activeItemIdForUpload] = { ...cloudData[activeItemIdForUpload], attachments: atts };
                await saveToFirestore(); window.renderDayTracker();
                document.getElementById('uploadLoader').classList.remove('flex'); document.getElementById('uploadLoader').classList.add('hidden'); e.target.value = '';
            };
            window.updateCalendarView(); window.renderDayTracker(); if ("Notification" in window) window.updateNotifUI(Notification.permission);
        });
    </script>
</body>
</html>
