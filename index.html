<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Primary Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tracker 2026">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Tracker 2026">
    <meta name="theme-color" content="#050810">
    
    <!-- Ikon (Pastikan file ada di folder root GitHub) -->
    <link rel="apple-touch-icon" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg">
    <link rel="icon" type="image/jpeg" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg">
    <link rel="shortcut icon" href="bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg">

    <link rel="manifest" id="pwa-manifest">

    <title>2026 Elite Discipline Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050810;
            color: #e2e8f0;
            letter-spacing: -0.01em;
            overscroll-behavior-y: contain;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .status-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .status-none { background-color: #1e293b; color: #94a3b8; }
        .status-done { background-color: #10b981 !important; color: white !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        .status-fail { background-color: #ef4444 !important; color: white !important; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        .note-input {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            font-size: 12px;
        }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.2s;
            font-size: 0.75rem;
        }

        .calendar-day.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        }

        .task-done-text { color: #64748b; text-decoration: line-through; opacity: 0.7; }

        #syncIndicator {
            position: fixed; bottom: 20px; right: 20px; padding: 10px 18px;
            border-radius: 99px; font-size: 11px; font-weight: 800;
            z-index: 100; display: flex; align-items: center; gap: 10px;
            text-transform: uppercase; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5);
        }

        .state-online { background: #064e3b; color: #34d399; border: 1px solid #059669; }
        .state-offline { background: #450a0a; color: #f87171; border: 1px solid #b91c1c; }
        .state-syncing { background: #451a03; color: #fbbf24; border: 1px solid #d97706; }

        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; position: relative; }
        .pulse-dot::after {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background-color: currentColor; animation: pulse 1.5s infinite; left: 0; top: 0;
        }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

        select { background-color: #1e293b; color: #f1f5f9; border: 1px solid rgba(255, 255, 255, 0.1); padding: 6px 12px; border-radius: 10px; font-size: 13px; }

        .attachment-badge { 
            background: rgba(59, 130, 246, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            padding: 4px 8px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 10px; 
            color: #94a3b8; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .attachment-preview { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background: #0f172a; }

        .fasting-alert { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 800; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
        
        .timer-panel { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 12px; margin-top: 10px; display: none; flex-direction: column; align-items: center; }
        .timer-display { font-family: 'Courier New', Courier, monospace; font-weight: 800; color: #60a5fa; font-size: 1.5rem; }
        
        footer { border-top: 1px solid rgba(255, 255, 255, 0.05); text-align: center; padding: 40px 20px; color: #64748b; font-size: 10px; font-weight: 700; letter-spacing: 1px; line-height: 1.6; }

        #imagePreviewModal {
            display: none; position: fixed; inset: 0; z-index: 11000;
            background: rgba(0,0,0,0.95); padding: 20px;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #previewImage { max-width: 100%; max-height: 80vh; border-radius: 12px; }

        /* Custom UI for Sync */
        #syncModal {
            display: none; position: fixed; inset: 0; z-index: 12000;
            background: rgba(0,0,0,0.9); padding: 20px;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-[#050810]">

    <div id="uploadLoader" class="fixed inset-0 bg-black/80 z-[20000] hidden flex-col items-center justify-center">
        <div class="pulse-dot text-blue-500 mb-4"></div>
        <p class="text-white font-bold text-[10px]">MENGELOLA BERKAS...</p>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" onclick="window.closeImagePreview()">
        <button class="absolute top-6 right-6 text-white text-3xl"><i class="fas fa-times"></i></button>
        <img id="previewImage" src="" alt="Preview">
        <p id="previewName" class="mt-4 text-slate-400 text-xs font-bold uppercase"></p>
    </div>

    <!-- Sync Modal -->
    <div id="syncModal">
        <div class="glass-card p-8 rounded-3xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-center">SINKRONISASI</h3>
            <p class="text-[10px] text-slate-400 mb-6 text-center uppercase tracking-wider leading-relaxed">Gunakan kode ini di perangkat lain agar data Desktop & HP lo menyatu.</p>
            
            <div class="mb-6">
                <label class="text-[9px] font-black text-blue-500 uppercase mb-2 block">Kode Sinkron Lo:</label>
                <div class="flex items-center gap-2">
                    <input id="mySyncCode" readonly class="bg-black/40 border border-white/10 p-3 rounded-xl text-[10px] w-full font-mono text-emerald-400">
                    <button onclick="window.copySyncCode()" class="bg-blue-600 p-3 rounded-xl"><i class="fas fa-copy"></i></button>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-[9px] font-black text-orange-500 uppercase mb-2 block">Ganti ke Kode Lain:</label>
                <div class="flex items-center gap-2">
                    <input id="inputSyncCode" placeholder="Masukkan kode perangkat lain..." class="bg-black/40 border border-white/10 p-3 rounded-xl text-[10px] w-full">
                    <button onclick="window.applySyncCode()" class="bg-orange-600 p-3 rounded-xl"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>

            <button onclick="document.getElementById('syncModal').style.display='none'" class="w-full py-3 text-[10px] font-black uppercase text-slate-500 hover:text-white transition-colors">Tutup</button>
        </div>
    </div>

    <div id="syncIndicator" class="state-syncing">
        <div class="pulse-dot"></div>
        <span id="syncText">Connecting</span>
    </div>

    <header class="sticky top-0 z-50 bg-[#050810]/80 backdrop-blur-xl border-b border-white/5 p-5">
        <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 items-center gap-6 text-center md:text-left">
            <div class="flex items-center gap-3 justify-center md:justify-start">
                <div class="w-1 h-10 bg-blue-500 rounded-full"></div>
                <div>
                    <p id="quoteText" class="text-[11px] text-slate-300 italic min-h-[30px]">"Memuat..."</p>
                    <div class="flex flex-wrap items-center gap-2 mt-1">
                        <button id="notifStatusBtn" onclick="window.requestNotifPermission()" class="text-[9px] font-bold uppercase tracking-widest flex items-center gap-1">
                            <i id="notifIcon" class="fas fa-bell"></i> <span id="notifText">Notif</span>
                        </button>
                        <button onclick="window.testNotification()" class="text-[9px] text-slate-500 font-bold uppercase border border-white/10 px-2 py-1 rounded">Tes Sound</button>
                        <button onclick="document.getElementById('syncModal').style.display='flex'" class="text-[9px] text-blue-400 font-bold uppercase bg-blue-500/10 px-2 py-1 rounded"><i class="fas fa-link"></i> Sinkron</button>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <h1 class="text-2xl font-extrabold text-white flex items-center gap-2">
                    <span class="text-blue-500"><i class="fas fa-bolt"></i></span> FOCUS LOG
                </h1>
                <p id="currentSelectionLabel" class="text-[11px] text-blue-400 font-bold uppercase mt-1">01 JAN 2026</p>
            </div>
            <div class="flex items-center justify-center md:justify-end gap-3">
                <select id="monthSelect" onchange="window.updateCalendarView()"></select>
                <select id="yearSelect" onchange="window.updateCalendarView()"></select>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-6 pb-20">
        <!-- Kalender -->
        <div class="glass-card p-6 rounded-[2rem] mb-10">
            <div class="grid grid-cols-7 gap-3 text-center mb-4 font-black text-slate-500 text-[10px] uppercase">
                <span>Min</span><span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-3"></div>
        </div>

        <div id="dayTrackerArea">
            <div id="dayHeader" class="flex items-end justify-between mb-8 px-2">
                <div>
                    <div id="fastingBadgeContainer"></div>
                    <h2 id="dayFullLabel" class="text-2xl font-extrabold text-white leading-none">...</h2>
                    <div class="flex items-center gap-3 mt-3">
                        <span id="sportTargetLabel" class="text-[11px] bg-blue-500/10 text-blue-400 px-3 py-1 rounded-full font-bold uppercase border border-blue-500/20">...</span>
                    </div>
                </div>
                <div class="text-right">
                    <span id="dayScore" class="text-4xl font-black text-emerald-400">0%</span>
                    <p class="text-[10px] text-slate-500 uppercase font-black">Progres</p>
                </div>
            </div>

            <div class="mb-6 px-2">
                <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-[3px] mb-4">Jadwal Utama</h3>
                <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
            </div>

            <div class="mt-12 px-2">
                <h3 class="text-[10px] font-black text-emerald-500 uppercase tracking-[3px] mb-4">Tugas Rutin & Ibadah</h3>
                <div id="extraTaskList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
            </div>
        </div>
    </main>

    <footer>
        <p>Â© 2026 ELITE DISCIPLINE TRACKER | ALL RIGHTS RESERVED</p>
        <p class="mt-1 opacity-40 font-medium uppercase text-[8px] sm:text-[10px]">DIRANCANG UNTUK PERFORMA TINGGI & KEDISPLINAN MUTLAK</p>
    </footer>

    <input type="file" id="globalFileInput" class="hidden" multiple accept="image/*,.pdf,.txt">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let dayUnsubscribe = null;
        let selectedDate = new Date(2026, 0, 1);
        let cloudData = {};
        let activeItemIdForUpload = null;
        let lastNotifDate = null;
        let deferredPrompt = null;
        window.openTimerPanels = {};

        const yearlyQuotes = [
            "Disiplin adalah jembatan antara target dan pencapaian.",
            "Waktu lo terbatas, jangan sia-siakan untuk hal yang nggak guna.",
            "Kemenangan dimulai dari jam 03:30 pagi.",
            "Fokus adalah kekuatan lo, asah terus setiap detik.",
            "Tahun 2026 adalah tahun pembuktian diri lo, bro.",
            "Jangan biarkan rasa malas mencuri masa depan lo.",
            "Lakukan hari ini apa yang orang lain tunda.",
            "Disiplin diri adalah bentuk tertinggi dari rasa cinta diri.",
            "Konsistensi lebih penting daripada intensitas sesaat.",
            "Terus melangkah, meskipun langkah itu kecil."
        ];

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6eXPEfB8aonq7M0c6pU4sVPlGoRJtYCQ",
            authDomain: "tracker-2026-4bbd9.firebaseapp.com",
            projectId: "tracker-2026-4bbd9",
            storageBucket: "tracker-2026-4bbd9.firebasestorage.app",
            messagingSenderId: "634119648342",
            appId: "1:634119648342:web:35aff0729cdcb37dcc37f7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const trackerId = "discipline-tracker-2026";

        enableIndexedDbPersistence(db).catch(() => {});

        // --- CORE LOGIC ---

        function updateSyncUI() {
            const indicator = document.getElementById('syncIndicator'), syncText = document.getElementById('syncText');
            if (!indicator || !syncText) return;
            if (!navigator.onLine) { indicator.className = 'state-offline'; syncText.innerText = "Offline"; }
            else if (auth.currentUser) { indicator.className = 'state-online'; syncText.innerText = "Cloud Online"; }
            else { indicator.className = 'state-syncing'; syncText.innerText = "Connecting"; }
        }

        function updateNotifUI(permission) {
            const icon = document.getElementById('notifIcon'), text = document.getElementById('notifText');
            if (!icon || !text) return;
            icon.className = `fas fa-bell notif-${permission}`;
            text.innerText = permission === "granted" ? "Aktif" : (permission === "denied" ? "Blok" : "Izin?");
        }

        function formatTime(ms) {
            if (ms <= 0) return "00:00";
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 3600) > 0 ? Math.floor(s / 3600) + ':' : ''}${Math.floor((s % 3600) / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        }

        async function initAuth() {
            updateSyncUI();
            try { await signInAnonymously(auth); } catch (e) { updateSyncUI(); }
        }

        function setupRealtimeSync() {
            if (!auth.currentUser) return;
            // Gunakan ID Manual jika pernah disimpan di localStorage
            const effectiveUid = localStorage.getItem('manual_sync_id') || auth.currentUser.uid;
            document.getElementById('mySyncCode').value = effectiveUid;
            
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            if (dayUnsubscribe) dayUnsubscribe();
            
            dayUnsubscribe = onSnapshot(doc(db, 'artifacts', trackerId, 'users', effectiveUid, 'calendar', docId), (snap) => {
                cloudData = snap.exists() ? snap.data() : {};
                window.renderDayTracker();
            }, (err) => { console.error("Sync Error:", err); updateSyncUI(); });
            window.updateCalendarView();
        }

        async function saveToFirestore() { 
            const effectiveUid = localStorage.getItem('manual_sync_id') || auth.currentUser?.uid;
            if (!effectiveUid) return; 
            const docId = `${selectedDate.getFullYear()}-${selectedDate.getMonth()}-${selectedDate.getDate()}`;
            await setDoc(doc(db, 'artifacts', trackerId, 'users', effectiveUid, 'calendar', docId), cloudData); 
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height, max_size = 1000;
                        if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                        else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    };
                };
            });
        }

        // --- CALENDAR & RENDER ---

        function updateCalendarView() {
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect'), grid = document.getElementById('calendarGrid');
            if (!yS || !mS || !grid) return;
            const year = parseInt(yS.value), month = parseInt(mS.value);
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const dayEl = document.createElement('div');
                const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                dayEl.className = `calendar-day relative glass-card ${isSelected ? 'active' : ''}`;
                dayEl.innerText = d;
                dayEl.onclick = () => { selectedDate = new Date(year, month, d); setupRealtimeSync(); };
                grid.appendChild(dayEl);
            }
        }

        window.renderDayTracker = function() {
            const isFri = selectedDate.getDay() === 5, isThu = selectedDate.getDay() === 4, isMon = selectedDate.getDay() === 1;
            const dNum = selectedDate.getDate(), mNum = selectedDate.getMonth();
            const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const dNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            
            document.getElementById('dayFullLabel').innerText = `${dNames[selectedDate.getDay()]}, ${dNum} ${mNames[mNum]} ${selectedDate.getFullYear()}`;
            document.getElementById('currentSelectionLabel').innerText = `${dNum < 10 ? '0'+dNum : dNum} ${mNames[mNum]} ${selectedDate.getFullYear()}`;
            document.getElementById('quoteText').innerText = `"${yearlyQuotes[(dNum + mNum * 31) % yearlyQuotes.length]}"`;
            
            const sched = { 1:{type:"Gowes", val:25}, 2:{type:"Gowes", val:25}, 3:{type:"Run", val:5}, 4:{type:"Gowes", val:30}, 5:{type:"Gowes", val:20}, 6:{type:"Run", val:5}, 0:{type:"Rest", val:0} }[selectedDate.getDay()];
            let runDist = 5 + Math.floor(mNum / 3);
            const sportGoal = sched.type === "Rest" ? "ðŸ›Œ Total Rest" : (sched.type === "Run" ? `ðŸƒ Lari ${runDist} KM` : `ðŸš´ Gowes ${sched.val} KM`);
            document.getElementById('sportTargetLabel').innerText = sportGoal;

            const ramStart = new Date(2026, 1, 18), ramEnd = new Date(2026, 2, 19);
            const fType = (selectedDate >= ramStart && selectedDate <= ramEnd) ? "Ramadhan" : (selectedDate.getDay() === 1 ? "Senin" : (selectedDate.getDay() === 4 ? "Kamis" : null));
            document.getElementById('fastingBadgeContainer').innerHTML = fType ? `<div class="fasting-alert">Puasa ${fType}</div>` : '';

            const routine = [
                { id: "english", time: "03:30", task: "Belajar Bahasa Inggris", icon: "fa-language", duration: 30 * 60000 },
                { id: "subuh", time: "04:15", task: "Bangun & Sholat Subuh", icon: "fa-mosque", noTimer: true },
                { id: "muscle_subuh", time: "05:00", task: "Muscle Up & Pull Up", icon: "fa-dumbbell", duration: 20 * 60000 },
                { id: "sport", time: "05:50", task: "Olahraga: " + sportGoal, icon: "fa-running", noTimer: true },
                { id: "dhuha", time: "07:45", task: "Sholat Dhuha", icon: "fa-hands-praying", noTimer: true },
                { id: "deep1", time: "08:30", task: "Deep Work Sesi 1", icon: "fa-keyboard", duration: 210 * 60000 },
                { id: "dzuhur", time: "12:00", task: "Sholat Dzuhur Berjamaah", icon: "fa-sun", noTimer: true },
                { id: "deep2", time: "13:30", task: "Deep Work Sesi 2", icon: "fa-brain", duration: 60 * 60000 },
                { id: "majelis", time: "14:30", task: "Jadwal Majelis", icon: "fa-users", fridayOnly: true, noTimer: true },
                { id: "ashar", time: "15:30", task: "Sholat Ashar", icon: "fa-coffee", noTimer: true },
                { id: "skipping", time: "17:15", task: "Skipping Sore", icon: "fa-bolt", duration: 15 * 60000 },
                { id: "mandi", time: "17:45", task: "Mandi & Santai", icon: "fa-bath", noTimer: true },
                { id: "maghrib", time: "18:00", task: "Sholat Maghrib", icon: "fa-moon", noTimer: true },
                { id: "quran", time: "18:20", task: "Membaca Al-Qur'an", icon: "fa-book-quran", duration: 20 * 60000 },
                { id: "isya", time: "18:45", task: "Sholat Isya Berjamaah", icon: "fa-star", noTimer: true },
                { id: "buku", time: "19:00", task: "Baca Buku (Pomodoro)", icon: "fa-book-open", isPomo: true },
                { id: "tidur", time: "20:30", task: "Tidur Malam", icon: "fa-bed", noTimer: true }
            ];

            const extra = [
                { id: "siram_pagi", task: "Menyiram Tanaman (Pagi)", icon: "fa-faucet-drip" },
                { id: "siram_sore", task: "Menyiram Tanaman (Sore)", icon: "fa-faucet-drip" },
                { id: "kasur", task: "Membersihkan Kasur", icon: "fa-bed" },
                { id: "sapu", task: "Menyapu Rumah", icon: "fa-broom" },
                { id: "piring", task: "Mencuci Piring", icon: "fa-sink" },
                { id: "istigfar", task: "Istigfar 1000x", icon: "fa-comment-dots" },
                { id: "taubat", task: "Sholat Taubat", icon: "fa-person-praying" },
                { id: "kuku", task: "Potong Kuku", icon: "fa-scissors", specialDaysKuku: true },
                { id: "cuci", task: "Cuci Pakaian", icon: "fa-shirt", fridayOnly: true }
            ];

            const render = (list, targetId) => {
                const container = document.getElementById(targetId);
                if (!container) return 0; container.innerHTML = ''; let done = 0;
                list.forEach(item => {
                    if (item.fridayOnly && !isFri) return;
                    if (item.id === "majelis" && fType === "Ramadhan") return;
                    if (item.specialDaysKuku && !isMon && !isThu && !isFri) return;
                    const itemData = cloudData[item.id] || {}, status = itemData.status || 'none';
                    if (status === 'done') done++;
                    const isTimerOpen = window.openTimerPanels[item.id];
                    let timerUI = '';
                    if (!item.noTimer && (item.duration || item.isPomo)) {
                        let rem = itemData.timerEnd ? itemData.timerEnd - Date.now() : (itemData.remainingMs || item.duration || 25*60000);
                        timerUI = `<div id="timer-panel-${item.id}" class="timer-panel" style="display: ${isTimerOpen ? 'flex' : 'none'}">${itemData.isPomo ? `<span class="pomo-badge ${itemData.pomoState === 'work' ? 'bg-orange-500' : 'bg-emerald-500'} text-white">Cycle ${itemData.pomoCycle || 1}/3</span>` : ''}<span class="timer-display">${window.formatTime(rem)}</span><div class="flex gap-4 mt-3"><button onclick="window.startCountdown('${item.id}', ${item.duration || 25*60000}, ${!!item.isPomo})" class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fas ${itemData.timerRunning ? 'fa-pause' : 'fa-play'}"></i></button><button onclick="window.stopTimer('${item.id}')" class="w-10 h-10 rounded-full bg-rose-500/20 text-rose-400 flex items-center justify-center"><i class="fas fa-stop"></i></button></div></div>`;
                    }
                    let attHtml = (itemData.attachments || []).map((f, i) => `<div class="attachment-badge relative group" onclick="window.openImagePreview('${f.data}', '${f.name}')">${f.data.startsWith('data:image/') ? `<img src="${f.data}" class="attachment-preview" />` : `<i class="fas fa-file-alt"></i>`}<span class="truncate max-w-[60px] ml-1">${f.name}</span><button onclick="event.stopPropagation(); window.removeAttachment('${item.id}', ${i})" class="absolute -top-1 -right-1 bg-rose-500 text-white w-3 h-3 rounded-full text-[7px] flex items-center justify-center"><i class="fas fa-times"></i></button></div>`).join('');
                    const card = document.createElement('div');
                    card.className = 'glass-card p-5 rounded-2xl flex flex-col hover:scale-[1.01] transition-transform';
                    card.innerHTML = `<div class="flex items-start justify-between"><div class="flex-1 pr-2"><div class="flex items-center gap-3 mb-2">${item.time ? `<span class="text-[9px] font-black text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded uppercase">${item.time}</span>` : ''}<i class="fas ${item.icon} text-[10px] text-slate-500"></i><h3 class="text-[13px] font-bold ${status === 'done' ? 'task-done-text' : 'text-slate-100'}">${item.task}</h3></div><textarea id="note-${item.id}" placeholder="Catatan..." class="note-input w-full mt-1 p-2 rounded-lg min-h-[40px] resize-none">${itemData.note || ''}</textarea><div class="flex flex-wrap gap-2 mt-2">${attHtml}</div><div class="flex gap-4 mt-3"><button onclick="window.triggerUpload('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-paperclip"></i> Berkas</button>${!item.noTimer && (item.duration || item.isPomo) ? `<button onclick="window.toggleTimerPanel('${item.id}')" class="text-slate-500 hover:text-blue-400 transition-colors text-[10px] font-bold uppercase tracking-wider"><i class="fas fa-clock"></i> Timer</button>` : ''}</div>${timerUI}</div><div class="flex flex-col gap-2 ml-2"><button onclick="window.updateStatus('${item.id}', '${status === 'done' ? 'none' : 'done'}')" class="w-10 h-10 rounded-xl flex items-center justify-center status-btn ${status === 'done' ? 'status-done' : 'status-none'}"><i class="fas fa-check"></i></button><button onclick="window.updateStatus('${item.id}', '${status === 'fail' ? 'none' : 'fail'}')" class="w-10 h-10 rounded-xl flex items-center justify-center status-btn ${status === 'fail' ? 'status-fail' : 'status-none'}"><i class="fas fa-times"></i></button></div></div>`;
                    card.querySelector(`#note-${item.id}`).onblur = (e) => window.updateNote(item.id, e.target.value);
                    container.appendChild(card);
                });
                return done;
            };
            const mD = render(routine, 'taskList');
            const eD = render(extra, 'extraTaskList');
            const total = document.querySelectorAll('#taskList .glass-card, #extraTaskList .glass-card').length || 1;
            document.getElementById('dayScore').innerText = Math.round(((mD + eD) / total) * 100) + '%';
        };

        // --- WINDOW BINDINGS ---
        window.formatTime = formatTime;
        window.updateSyncUI = updateSyncUI;
        window.updateNotifUI = updateNotifUI;
        window.updateCalendarView = updateCalendarView;
        window.initAuth = initAuth;
        window.setupRealtimeSync = setupRealtimeSync;

        window.toggleTimerPanel = (id) => { window.openTimerPanels[id] = !window.openTimerPanels[id]; window.renderDayTracker(); };
        window.startCountdown = (id, d, p = false) => {
            const t = cloudData[id] || {};
            if (t.timerRunning) { t.timerRunning = false; t.remainingMs = (t.timerEnd || 0) - Date.now(); cloudData[id] = t; saveToFirestore(); window.renderDayTracker(); return; }
            t.timerRunning = true; t.timerEnd = Date.now() + (t.remainingMs || d);
            if (p && !t.pomoState) { t.pomoState = 'work'; t.pomoCycle = 1; t.timerEnd = Date.now() + (25 * 60000); }
            cloudData[id] = t; saveToFirestore(); window.renderDayTracker();
        };
        window.stopTimer = (id) => {
            const list = [{ id: "english", duration: 30 * 60000 },{ id: "muscle_subuh", duration: 20 * 60000 },{ id: "deep1", duration: 210 * 60000 },{ id: "muscle_dzuhur", duration: 20 * 60000 },{ id: "deep2", duration: 60 * 60000 },{ id: "majelis", duration: 240 * 60000 },{ id: "skipping", duration: 15 * 60000 },{ id: "quran", duration: 20 * 60000 },{ id: "buku", duration: 25 * 60000 }];
            const item = list.find(x => x.id === id);
            cloudData[id] = { ...cloudData[id], timerRunning: false, timerEnd: null, remainingMs: item?.duration || 25*60000, pomoState: null, pomoCycle: null };
            saveToFirestore(); window.renderDayTracker();
        };
        window.updateStatus = async (id, s) => { cloudData[id] = { ...cloudData[id], status: s }; window.renderDayTracker(); saveToFirestore(); };
        window.updateNote = async (id, n) => { if (cloudData[id]?.note === n) return; cloudData[id] = { ...cloudData[id], note: n }; saveToFirestore(); };
        window.triggerUpload = (id) => { activeItemIdForUpload = id; document.getElementById('globalFileInput').click(); };
        window.removeAttachment = async (id, i) => { cloudData[id].attachments.splice(i, 1); window.renderDayTracker(); saveToFirestore(); };
        window.openImagePreview = (data, name) => { const m = document.getElementById('imagePreviewModal'), img = document.getElementById('previewImage'), n = document.getElementById('previewName'); if (data.startsWith('data:image/')) { img.src = data; img.style.display = 'block'; } else { img.style.display = 'none'; } n.innerText = name; m.style.display = 'flex'; };
        window.closeImagePreview = () => { document.getElementById('imagePreviewModal').style.display = 'none'; };
        
        window.copySyncCode = () => { const c = document.getElementById('mySyncCode'); c.select(); document.execCommand('copy'); alert("Kode disalin! Masukkan ini di perangkat lain lo."); };
        window.applySyncCode = () => { const c = document.getElementById('inputSyncCode').value.trim(); if (c.length < 5) return; localStorage.setItem('manual_sync_id', c); window.setupRealtimeSync(); alert("Berhasil Terhubung! Data lo sekarang tersinkron."); };

        window.requestNotifPermission = () => {
            if (!("Notification" in window)) return;
            Notification.requestPermission().then(p => { window.updateNotifUI(p); if (p === "granted") new Notification("Elite Tracker", { body: "Notif 03:30 Aktif!", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg" }); });
        };
        window.testNotification = () => {
            if (Notification.permission === "granted") {
                new Notification("SISTEM TES", { body: "Jika lo liat ini, notifikasi HP lo aman!", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg", requireInteraction: true });
                if ("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
            } else { alert("Izin notifikasi diblokir! Klik ikon lonceng dulu."); }
        };

        // --- TICKER ---
        setInterval(() => {
            window.updateSyncUI();
            let re = false;
            Object.keys(cloudData).forEach(id => {
                if (cloudData[id].timerRunning) {
                    re = true; let rem = cloudData[id].timerEnd - Date.now();
                    if (rem <= 0) {
                        if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]);
                        if (id === 'buku') {
                            if (cloudData[id].pomoState === 'work') { cloudData[id].pomoState = 'rest'; cloudData[id].timerEnd = Date.now() + (5 * 60000); }
                            else { cloudData[id].pomoState = 'work'; cloudData[id].pomoCycle = (cloudData[id].pomoCycle || 1) < 3 ? (cloudData[id].pomoCycle || 1) + 1 : 1; cloudData[id].timerEnd = Date.now() + (25 * 60000); if (cloudData[id].pomoCycle === 1 && cloudData[id].pomoState === 'work') cloudData[id].timerRunning = false; }
                        } else { cloudData[id].timerRunning = false; cloudData[id].remainingMs = 0; }
                        saveToFirestore();
                    }
                }
            });
            if (re) window.renderDayTracker();
            
            const now = new Date();
            const witaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Makassar"}));
            if (witaTime.getHours() === 3 && witaTime.getMinutes() === 30 && lastNotifDate !== witaTime.toDateString()) {
                if (Notification.permission === "granted") {
                    new Notification("ðŸ† Waktunya Eksekusi!", { body: "Bro, jam 03:30 WITA! Bangun & isi progres tracker lo.", icon: "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg", requireInteraction: true });
                }
                lastNotifDate = witaTime.toDateString();
            }
        }, 1000);

        // --- INIT ---
        window.addEventListener('load', async () => {
            const yS = document.getElementById('yearSelect'), mS = document.getElementById('monthSelect');
            for(let y=2026; y<=2030; y++) { let o = document.createElement('option'); o.value = y; o.innerText = y; yS.appendChild(o); }
            ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"].forEach((m, i) => { let o = document.createElement('option'); o.value = i; o.innerText = m; mS.appendChild(o); });
            yS.value = "2026"; mS.value = "0"; 

            // Setup PWA
            const manifestData = { "name": "Tracker 2026", "short_name": "T2026", "start_url": ".", "display": "standalone", "background_color": "#050810", "theme_color": "#050810", "icons": [{ "src": "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg", "sizes": "731x731", "type": "image/jpeg" }, { "src": "bd6827df3278be14d7259f18d8717c03f160cc05-731x731.jpg", "sizes": "192x192", "type": "image/jpeg" }] };
            document.getElementById('pwa-manifest').href = URL.createObjectURL(new Blob([JSON.stringify(manifestData)], {type:'application/json'}));

            onAuthStateChanged(auth, (user) => { window.updateSyncUI(); if (user) window.setupRealtimeSync(); });
            await window.initAuth();
            window.renderDayTracker();
            if ("Notification" in window) window.updateNotifUI(Notification.permission);
        });

        document.getElementById('globalFileInput').onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length || !activeItemIdForUpload) return;
            document.getElementById('uploadLoader').classList.remove('hidden');
            document.getElementById('uploadLoader').classList.add('flex');
            const attachments = cloudData[activeItemIdForUpload]?.attachments || [];
            for (let f of files) {
                try {
                    let data = "";
                    if (f.type.startsWith('image/')) data = await compressImage(f);
                    else { if (f.size > 1024*1024) continue; data = await new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }); }
                    attachments.push({ name: f.name, data: data });
                } catch(err) { console.error(err); }
            }
            cloudData[activeItemIdForUpload] = { ...cloudData[activeItemIdForUpload], attachments };
            await saveToFirestore(); window.renderDayTracker();
            document.getElementById('uploadLoader').classList.add('hidden');
            document.getElementById('uploadLoader').classList.remove('flex');
        };
    </script>
</body>
</html>
